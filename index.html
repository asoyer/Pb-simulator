<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PB Allocation Engine – Roadshow</title>

  <meta name="theme-color" content="#123a63">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --ink:#0b1a2a; --muted:#5b6777;
      --line:#e6e9f2; --accent:#c8a33a; --accent2:#123a63;
      --danger:#9b1c1c;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background:var(--bg); color:var(--ink);
    }
    header{
      padding:16px 14px 10px;
      background:linear-gradient(180deg,#fff 0%, #f6f7fb 100%);
      border-bottom:1px solid var(--line);
      position:sticky; top:0; z-index:10;
    }
    h1{margin:0; font-size:16px; letter-spacing:.2px}
    .sub{margin-top:6px; color:var(--muted); font-size:12.5px; line-height:1.35}
    .wrap{max-width:1240px; margin:0 auto; padding:12px 12px 26px}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow:0 6px 18px rgba(12,26,43,.06);
    }
    .card h2{margin:0 0 10px; font-size:13px; color:var(--accent2); letter-spacing:.2px}

    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      font-size:14px;
      background:#fff;
    }
    input:focus, select:focus{
      border-color: rgba(18,58,99,.35);
      box-shadow: 0 0 0 4px rgba(18,58,99,.08);
    }

    .topbar{display:flex; gap:12px; flex-wrap:wrap; align-items:stretch;}
    .topcol{flex:1; min-width:260px;}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}

    .btns{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .btns.scroller{flex-wrap:nowrap; overflow-x:auto; padding-bottom:6px}
    .btns.scroller::-webkit-scrollbar{height:6px}
    .btns.scroller::-webkit-scrollbar-thumb{background:#d9deea; border-radius:999px}
    button{border:none; border-radius:12px; padding:12px 12px; font-size:14px; cursor:pointer; white-space:nowrap}
    .primary{background:var(--accent2); color:#fff}
    .ghost{background:#fff; border:1px solid var(--line); color:var(--ink)}
    .danger{background:rgba(155,28,28,.08); border:1px solid rgba(155,28,28,.22); color:var(--danger)}
    .small{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.35}
    .pill{
      display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px;
      background: rgba(200,163,58,.12); color:#6a5207; border:1px solid rgba(200,163,58,.25);
      margin-right:6px; margin-top:6px;
    }

    .tableWrap{
      width:100%;
      overflow-x:auto;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      margin-top:10px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:1120px;
      font-size:13px;
    }
    th, td{padding:10px 8px; border-bottom:1px solid var(--line); text-align:left; vertical-align:middle}
    th{font-size:12px; color:var(--muted); font-weight:600}

    /* Tablo içi kutuları daralt */
    .tableWrap input, .tableWrap select{
      padding:10px 10px;
      border-radius:12px;
      font-size:13px;
    }

    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .kpi .box{border:1px solid var(--line); border-radius:14px; padding:12px; background:#fff}
    .kpi .t{color:var(--muted); font-size:12px}
    .kpi .v{margin-top:6px; font-size:18px; font-weight:780; letter-spacing:.2px}

    .watermark{
      position:fixed; right:10px; bottom:10px;
      font-size:13px; font-weight:700;
      color:rgba(11,26,42,.45);
      background:rgba(255,255,255,.78);
      border:1px solid rgba(230,233,242,.9);
      padding:8px 14px; border-radius:999px;
      backdrop-filter: blur(6px);
    }
    .inlineWarn{margin-top:10px; font-size:12px; color:var(--danger)}
    .mutedLine{margin-top:6px; font-size:12px; color:var(--muted)}

    .miniBtn{padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer; font-size:12px;}

    /* Kolon genişlikleri (daha dar) */
    .wAmt{min-width:95px}
    .wProd{min-width:160px}
    .wCcy{min-width:90px}
    .wRate{min-width:80px}
    .wCalc{min-width:155px}
    .wTax{min-width:105px}
    .wBtn{min-width:70px}

    .taxWrap{display:flex; gap:8px; align-items:center;}
    .taxWrap label{display:flex; gap:6px; align-items:center; margin:0; font-size:12px; color:var(--muted); white-space:nowrap;}
    .taxWrap input[type="checkbox"]{width:auto; padding:0; margin:0; transform: translateY(1px);}

    /* Alt bölüm (tek donut + sağ özet) */
    .bottomGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    .chartCard{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      padding:12px;
    }
    .chartTitle{font-size:12px;color:var(--muted);margin-bottom:8px}
    .donutWrap{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    canvas{width:280px; height:220px; border-radius:14px; background:#fff;}

    @media (max-width: 980px){
      .bottomGrid{grid-template-columns: 1fr;}
      table{min-width:1040px;}
    }
  </style>
</head>

<body>
<header>
  <h1>PB Allocation Engine <span class="pill">Roadshow</span></h1>
  <div class="sub">
    Spot + Forward (getiri farkı) ile vade sonu kurlar → Giriş para birimine dönüşte Net P/L.
    <span class="pill" style="margin-left:8px">Build: V15</span>
  </div>
</header>

<div class="wrap">

  <div class="card">
    <div class="topbar">
      <div class="topcol">
        <h2>1) Müşteri Varlığı</h2>

        <label>Toplam Varlık</label>
        <input id="total_amount" type="text" inputmode="decimal" value="1.000.000" />

        <div class="row">
          <div>
            <label>Giriş Para Birimi (Principal)</label>
            <select id="total_ccy">
              <option value="USD" selected>USD</option>
              <option value="TL">TL</option>
              <option value="EUR">EUR</option>
              <option value="XAUg">Altın (gram)</option>
            </select>
          </div>
          <div>
            <label>Rapor Para Birimi (Dashboard)</label>
            <select id="report_ccy">
              <option value="TL">TL</option>
              <option value="USD" selected>USD</option>
              <option value="EUR">EUR</option>
              <option value="XAUg">Altın (gram)</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Global Vade Tipi</label>
            <select id="tenor_type">
              <option value="DAYS" selected>Gün</option>
              <option value="MONTHS">Ay</option>
            </select>
          </div>
          <div>
            <label>Global Vade</label>
            <input id="tenor_val" type="number" step="1" value="183" />
          </div>
        </div>

        <div class="small">Vade bir kez seçilir → tüm satırlara otomatik uygulanır.</div>
      </div>

      <div class="topcol">
        <h2>2) Başlangıç Kurları (Spot)</h2>

        <div class="row3">
          <div>
            <label>Altın (gram/TRY)</label>
            <input id="xautry_g" type="number" step="0.01" value="0" />
          </div>
          <div>
            <label>USD/TRY</label>
            <input id="usdtry" type="number" step="0.0001" value="0" />
          </div>
          <div>
            <label>EUR/TRY</label>
            <input id="eurtry" type="number" step="0.0001" value="0" />
          </div>
        </div>

        <div class="btns">
          <button class="ghost" id="btn_rates">Kurları Çek</button>
          <button class="ghost" id="btn_use_manual">Manuel Kur Kullan</button>
        </div>
        <div id="rate_status" class="mutedLine"></div>

        <div class="small">Not: Kaynak engellenirse USD/EUR alternatif kaynaktan gelir; altın manuel olabilir.</div>
      </div>

      <div class="topcol">
        <h2>3) Vade Sonu Kurları (Oto)</h2>

        <div class="row">
          <div>
            <label>Vade Sonu Kur Modu</label>
            <select id="end_mode">
              <option value="SPOT" selected>Spot = Vade Sonu</option>
              <option value="FWD">Forward (getiri farkı)</option>
              <option value="MANUAL">Manuel</option>
            </select>
          </div>
          <div>
            <label>Altın Beklenti (yıllık %)</label>
            <input id="gold_exp" type="number" step="0.01" value="0" />
          </div>
        </div>

        <div class="row3">
          <div>
            <label>Altın (gram/TRY) – Vade Sonu</label>
            <input id="xautry_g_end" type="number" step="0.01" value="" placeholder="oto dolar" />
          </div>
          <div>
            <label>USD/TRY – Vade Sonu</label>
            <input id="usdtry_end" type="number" step="0.0001" value="" placeholder="oto dolar" />
          </div>
          <div>
            <label>EUR/TRY – Vade Sonu</label>
            <input id="eurtry_end" type="number" step="0.0001" value="" placeholder="oto dolar" />
          </div>
        </div>

        <div class="row3">
          <div>
            <label>TL getirisi (yıllık %)</label>
            <input id="rtl" type="number" step="0.01" value="45" />
          </div>
          <div>
            <label>USD getirisi (yıllık %)</label>
            <input id="rusd" type="number" step="0.01" value="5" />
          </div>
          <div>
            <label>EUR getirisi (yıllık %)</label>
            <input id="reur" type="number" step="0.01" value="3" />
          </div>
        </div>

        <div class="btns">
          <button class="ghost" id="btn_fill_end" style="flex:1;">Vade Sonu Kurları Doldur</button>
          <button class="primary" id="btn_calc" style="flex:1;">Hesapla</button>
          <button class="danger" id="btn_reset" style="flex:1;">Sıfırla</button>
        </div>

        <div class="small" id="end_note"></div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <h2>Alokasyon (Tutar Bazlı) <span class="pill" id="pillInfo">hazır</span></h2>

    <div class="kpi" style="grid-template-columns:1fr; margin-top:12px;">
      <div class="box">
        <div class="t">Headline – Net P/L (Giriş Para Birimi)</div>
        <div class="v" id="headline_pl">-</div>
        <div class="mutedLine" id="headline_detail"></div>
      </div>
    </div>

    <div id="risk_badges" class="small" style="margin-top:8px;"></div>

    <div class="btns scroller" style="margin-top:10px;">
      <button class="ghost" id="btn_add">+ Satır Ekle</button>
      <button class="ghost" id="btn_s1">Dengeli</button>
      <button class="ghost" id="btn_s2">Koruma</button>
      <button class="ghost" id="btn_s3">Büyüme (Riskli)</button>
      <button class="ghost" id="btn_s4">FX Hedge</button>
      <button class="ghost" id="btn_s5">DPM Ağırlıklı</button>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th class="wAmt" id="hdr_amt">Tutar (Giriş PB)</th>
            <th class="wProd">Ürün</th>
            <th class="wCcy">Hedef PB</th>
            <th class="wRate">Getiri %</th>
            <th class="wCalc">Hesap</th>
            <th class="wTax">Stopaj</th>
            <th>Anapara (Hedef PB)</th>
            <th>Vade Sonu (Hedef PB)</th>
            <th>Net Kazanç (Hedef PB)</th>
            <th class="wBtn"></th>
          </tr>
        </thead>
        <tbody id="allocBody"></tbody>
      </table>
    </div>

    <div class="kpi">
      <div class="box">
        <div class="t">Kullanılan Tutar (Giriş PB)</div>
        <div class="v" id="kpi_used">-</div>
      </div>
      <div class="box">
        <div class="t">Kalan Tutar (Giriş PB)</div>
        <div class="v" id="kpi_left">-</div>
      </div>
    </div>

    <div class="kpi">
      <div class="box">
        <div class="t">Portföy Toplamı (Rapor PB) – Vade Sonu</div>
        <div class="v" id="kpi_total_report">-</div>
      </div>
      <div class="box">
        <div class="t">Toplam Net P/L (Rapor PB) – FX dahil</div>
        <div class="v" id="kpi_pl_report">-</div>
      </div>
    </div>

    <div class="kpi">
      <div class="box">
        <div class="t">Toplam Stopaj (Rapor PB)</div>
        <div class="v" id="kpi_tax_report">-</div>
      </div>
      <div class="box">
        <div class="t">Başlangıç Değeri (Rapor PB)</div>
        <div class="v" id="kpi_start_report">-</div>
      </div>
    </div>

    <!-- ALT: Tek donut + sağda vade sonu yazılı özet -->
    <div class="bottomGrid">
      <div class="chartCard">
        <div class="chartTitle">Dağılım (Başlangıç – Rapor PB)</div>
        <div class="donutWrap">
          <canvas id="pieStart" width="420" height="320"></canvas>
          <div style="min-width:220px">
            <div id="pieLegend" class="small"></div>
          </div>
        </div>
      </div>

      <div class="chartCard">
        <div class="chartTitle">Vade Sonu Özet (müşteri hızlı görsün)</div>
        <div class="kpi" style="margin-top:0;">
          <div class="box">
            <div class="t">Vade Sonu Toplam (Giriş PB)</div>
            <div class="v" id="end_total_principal">-</div>
          </div>
          <div class="box">
            <div class="t">Vade Sonu Toplam (Rapor PB)</div>
            <div class="v" id="end_total_report">-</div>
          </div>
        </div>
        <div class="kpi">
          <div class="box">
            <div class="t">Başlangıç (Giriş PB)</div>
            <div class="v" id="start_total_principal">-</div>
          </div>
          <div class="box">
            <div class="t">Başlangıç (Rapor PB)</div>
            <div class="v" id="start_total_report2">-</div>
          </div>
        </div>

        <div class="small" style="margin-top:8px">
          Not: “Toplam Net P/L (Rapor PB)” = Vade sonu toplam − başlangıç toplam. (FX etkisi dahil)
        </div>
      </div>
    </div>

    <div id="warn" class="inlineWarn"></div>
  </div>

</div>

<div class="watermark">Adem Soyer</div>

<script>
  // -------- Helpers --------
  function parseAmount(str){
    if(!str) return 0;
    let s = String(str).trim().replace(/\s/g,'');
    // TR style: 1.000.000,50 OR 1,000,000.50 OR plain
    // Convert: remove thousands separators; keep decimal if any
    if(s.includes(',') && s.includes('.')){
      // assume thousands + decimal mixed -> remove both (we'll treat as integer)
      // safer: if last separator is ',' => decimal is ',', else '.'.
      const lastComma = s.lastIndexOf(',');
      const lastDot = s.lastIndexOf('.');
      if(lastComma > lastDot){
        s = s.replace(/\./g,'').replace(',', '.'); // 1.000.000,50 -> 1000000.50
      }else{
        s = s.replace(/,/g,''); // 1,000,000.50 -> 1000000.50
      }
    } else if(s.includes(',')){
      // could be decimal comma or thousand comma. assume decimal if single and 2 digits after
      const parts = s.split(',');
      if(parts.length===2 && parts[1].length<=2) s = parts[0].replace(/\./g,'') + '.' + parts[1];
      else s = s.replace(/,/g,'').replace(/\./g,'');
    } else {
      // only dots -> thousands in TR
      s = s.replace(/\./g,'');
    }
    const n = Number(s);
    return isFinite(n) ? n : 0;
  }
  function fmtMoney(n, ccy){
    const abs = Math.abs(n);
    const opts = abs >= 100000 ? { maximumFractionDigits: 0 } : { maximumFractionDigits: 2 };
    return new Intl.NumberFormat('tr-TR', opts).format(n) + ' ' + ccy;
  }
  function clamp(x){ return Math.max(0, Number(x)||0); }

  function fmtTRInput(n){
    // For inputs: show thousands '.' and no decimals by default
    if(!isFinite(n)) return '';
    const opts = (Math.abs(n) >= 1000) ? { maximumFractionDigits: 2 } : { maximumFractionDigits: 2 };
    // We'll show up to 2 decimals if present
    return new Intl.NumberFormat('tr-TR', opts).format(n);
  }

  function setAmtHeader(){
    const ccy = document.getElementById('total_ccy').value;
    document.getElementById('hdr_amt').textContent = 'Tutar (Giriş PB – ' + ccy + ')';
  }

  // -------- Global tenor --------
  function globalDays(){
    const t = document.getElementById('tenor_type').value;
    const v = Number(document.getElementById('tenor_val').value)||0;
    const n = clamp(v);
    return (t==='DAYS') ? n : (n*30.4375);
  }

  // -------- Rates (start/end) --------
  function getStartRates(){
    return {
      usdtry: Number(document.getElementById('usdtry').value)||0,
      eurtry: Number(document.getElementById('eurtry').value)||0,
      xautry_g: Number(document.getElementById('xautry_g').value)||0
    };
  }
  function setEndRates(o){
    if(o.xautry_g != null && isFinite(o.xautry_g)) document.getElementById('xautry_g_end').value = Number(o.xautry_g).toFixed(2);
    if(o.usdtry != null && isFinite(o.usdtry)) document.getElementById('usdtry_end').value = Number(o.usdtry).toFixed(4);
    if(o.eurtry != null && isFinite(o.eurtry)) document.getElementById('eurtry_end').value = Number(o.eurtry).toFixed(4);
  }
  function getEndRatesResolved(){
    const s = getStartRates();
    const usdtry_end = Number(document.getElementById('usdtry_end').value)||0;
    const eurtry_end = Number(document.getElementById('eurtry_end').value)||0;
    const xautry_g_end = Number(document.getElementById('xautry_g_end').value)||0;
    return {
      usdtry: usdtry_end>0 ? usdtry_end : s.usdtry,
      eurtry: eurtry_end>0 ? eurtry_end : s.eurtry,
      xautry_g: xautry_g_end>0 ? xautry_g_end : s.xautry_g
    };
  }

  // FX conversion uses TRY as bridge; supports TL, USD, EUR, XAUg
  function fxRate(from, to, when){ // when: 'start' | 'end'
    if(from === to) return 1;

    const r = (when === 'end') ? getEndRatesResolved() : getStartRates();
    const usdtry = r.usdtry, eurtry = r.eurtry, xautry_g = r.xautry_g;

    const toTRY = (ccy)=>{
      if(ccy==='TL') return 1;
      if(ccy==='USD') return usdtry>0 ? usdtry : null;
      if(ccy==='EUR') return eurtry>0 ? eurtry : null;
      if(ccy==='XAUg') return xautry_g>0 ? xautry_g : null;
      return null;
    };
    const fromTRY = (ccy)=>{
      if(ccy==='TL') return 1;
      if(ccy==='USD') return usdtry>0 ? (1/usdtry) : null;
      if(ccy==='EUR') return eurtry>0 ? (1/eurtry) : null;
      if(ccy==='XAUg') return xautry_g>0 ? (1/xautry_g) : null;
      return null;
    };

    const a = toTRY(from);
    const b = fromTRY(to);
    if(a==null || b==null) return null;
    return a*b;
  }

  // -------- Fetch spot rates (Trunçgil + fallback) --------
  async function fetchRatesAll(){
    const status = document.getElementById('rate_status');
    status.textContent = 'Kurlar çekiliyor…';

    try{
      const res = await fetch('https://finans.truncgil.com/v4/today.json', { cache:'no-store' });
      if(res.ok){
        const data = await res.json();
        const usd = data?.USD?.Selling ?? data?.USD?.Buying;
        const eur = data?.EUR?.Selling ?? data?.EUR?.Buying;
        const gra = data?.GRA?.Selling ?? data?.GRA?.Buying;
        if(usd && eur){
          document.getElementById('usdtry').value = Number(usd).toFixed(4);
          document.getElementById('eurtry').value = Number(eur).toFixed(4);
          if(gra) document.getElementById('xautry_g').value = Number(gra).toFixed(2);
          status.textContent = 'USD/EUR/Altın güncellendi.';
          autoFillEndRates();
          return;
        }
      }
    }catch(e){}

    try{
      const r = await fetch('https://open.er-api.com/v6/latest/TRY', { cache:'no-store' });
      if(!r.ok) throw new Error('fallback failed');
      const j = await r.json();
      const usd = j?.rates?.USD;
      const eur = j?.rates?.EUR;
      if(usd && eur){
        document.getElementById('usdtry').value = (1/Number(usd)).toFixed(4);
        document.getElementById('eurtry').value = (1/Number(eur)).toFixed(4);
        status.textContent = 'USD/EUR alternatif kaynaktan güncellendi. Altın manuel.';
        autoFillEndRates();
        return;
      }
      throw new Error('rates missing');
    }catch(e2){
      status.textContent = 'Kurlar çekilemedi. Manuel girip devam edebilirsin.';
    }
  }

  // -------- Forward logic for END rates --------
  function autoFillEndRates(){
    const mode = document.getElementById('end_mode').value;
    const note = document.getElementById('end_note');
    const s = getStartRates();
    const days = globalDays();
    const T = days/365;

    if(mode !== 'MANUAL'){
      if(s.usdtry<=0 || s.eurtry<=0){
        note.textContent = 'Not: Spot/Forward için önce USD/TRY ve EUR/TRY girilmeli ya da çekilmeli.';
        return;
      }
    }

    if(mode === 'MANUAL'){
      note.textContent = 'Manuel mod: vade sonu kurları sen girersin.';
      return;
    }

    if(mode === 'SPOT'){
      setEndRates({
        usdtry: s.usdtry,
        eurtry: s.eurtry,
        xautry_g: s.xautry_g>0 ? s.xautry_g : null
      });
      note.textContent = 'Spot = Vade Sonu: End kurlar spot ile aynı kabul edildi.';
      return;
    }

    // Forward proxy: F = S * (1+rTL*T)/(1+rFX*T)
    const rTL = (Number(document.getElementById('rtl').value)||0)/100;
    const rUSD = (Number(document.getElementById('rusd').value)||0)/100;
    const rEUR = (Number(document.getElementById('reur').value)||0)/100;

    const usdEnd = s.usdtry * ((1 + rTL*T) / (1 + rUSD*T));
    const eurEnd = s.eurtry * ((1 + rTL*T) / (1 + rEUR*T));

    const gExp = (Number(document.getElementById('gold_exp').value)||0)/100;
    const goldEnd = (s.xautry_g>0) ? (s.xautry_g * (1 + gExp*T)) : null;

    setEndRates({ usdtry: usdEnd, eurtry: eurEnd, xautry_g: goldEnd });
    note.textContent = 'Forward modu: USD/TRY ve EUR/TRY faiz farkı ile türetildi (proxy). Altın: beklenti % ile.';
  }

  // -------- Product math --------
  function fvSimple(P, annualPct, days){
    const r = (Number(annualPct)||0)/100;
    return P * (1 + r * (days/365));
  }
  function fvDailyCompound(P, annualPct, days){
    const r = (Number(annualPct)||0)/100;
    return P * Math.pow(1 + r/365, days);
  }

  // -------- Stopaj suggestion (Auto) --------
  function suggestTaxPct(prod, targetCcy, days){
    if(prod === 'TERM'){
      if(targetCcy !== 'TL') return 25;
      if(days <= 183) return 17.5;
      if(days <= 365) return 15;
      return 10;
    }
    return 0;
  }

  // -------- Donut chart (single, hi-res) --------
  function drawDonut(canvas, labels, values){
    const ctx = canvas.getContext('2d');
    // make it crisp
    const dpr = window.devicePixelRatio || 1;
    const cssW = 280, cssH = 220;
    canvas.style.width = cssW + 'px';
    canvas.style.height = cssH + 'px';
    canvas.width = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);
    ctx.scale(dpr, dpr);

    ctx.clearRect(0,0,cssW,cssH);

    const cx = cssW/2, cy = cssH/2;
    const R = Math.min(cssW, cssH) * 0.42;
    const r = R * 0.62;

    const total = values.reduce((a,b)=>a+b,0) || 1;
    let ang = -Math.PI/2;

    const palette = [
      'rgba(18,58,99,.88)',
      'rgba(200,163,58,.92)',
      'rgba(91,103,119,.75)',
      'rgba(18,58,99,.55)',
      'rgba(200,163,58,.55)'
    ];

    for(let i=0;i<labels.length;i++){
      const v = Math.max(0, values[i]);
      const a = (v/total) * Math.PI*2;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,R,ang,ang+a);
      ctx.closePath();
      ctx.fillStyle = palette[i % palette.length];
      ctx.fill();

      // small highlight ring
      ctx.beginPath();
      ctx.arc(cx,cy,R,ang,ang+a);
      ctx.strokeStyle = 'rgba(255,255,255,.55)';
      ctx.lineWidth = 2;
      ctx.stroke();

      ang += a;
    }

    // hole
    ctx.beginPath();
    ctx.arc(cx,cy,r,0,Math.PI*2);
    ctx.fillStyle = '#fff';
    ctx.fill();

    ctx.fillStyle = 'rgba(11,26,42,.85)';
    ctx.font = '700 14px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial';
    const t1 = 'Dağılım';
    ctx.fillText(t1, cx - ctx.measureText(t1).width/2, cy - 4);
    ctx.font = '12px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial';
    const t2 = '(Başlangıç)';
    ctx.fillStyle = 'rgba(91,103,119,.95)';
    ctx.fillText(t2, cx - ctx.measureText(t2).width/2, cy + 14);
  }

  // -------- Rows --------
  const PRODUCT_OPTIONS = [
    { val:'TERM', label:'Vadeli Mevduat' },
    { val:'FUND', label:'Yatırım Fonu' },
    { val:'SUKUK', label:'Sukuk' },
    { val:'DPM',  label:'DPM' }
  ];

  function rowTemplate(id){
    const prodOpts = PRODUCT_OPTIONS.map(o=>'<option value="'+o.val+'">'+o.label+'</option>').join('');
    return ''+
      '<tr data-id="'+id+'">'+
        '<td class="wAmt"><input class="num" type="text" inputmode="decimal" id="amt_'+id+'" value="0"></td>'+
        '<td class="wProd"><select id="prod_'+id+'">'+prodOpts+'</select></td>'+
        '<td class="wCcy">'+
          '<select id="ccy_'+id+'">'+
            '<option value="TL">TL</option>'+
            '<option value="USD" selected>USD</option>'+
            '<option value="EUR">EUR</option>'+
            '<option value="XAUg">Altın</option>'+
          '</select>'+
        '</td>'+
        '<td class="wRate"><input type="number" step="0.01" id="rate_'+id+'" value="0"></td>'+
        '<td class="wCalc">'+
          '<select id="method_'+id+'">'+
            '<option value="DAILY_COMPOUND" selected>Günlük (bileşik)</option>'+
            '<option value="SIMPLE">Basit (bankacılık)</option>'+
          '</select>'+
        '</td>'+
        '<td class="wTax">'+
          '<div class="taxWrap">'+
            '<input type="number" step="0.01" id="tax_'+id+'" value="0" style="flex:1;">'+
            '<label><input type="checkbox" id="taxAuto_'+id+'" checked>Auto</label>'+
          '</div>'+
        '</td>'+
        '<td id="p_'+id+'">-</td>'+
        '<td id="fv_'+id+'">-</td>'+
        '<td id="net_'+id+'">-</td>'+
        '<td class="wBtn"><button class="miniBtn" onclick="removeRow(\''+id+'\')">Sil</button></td>'+
      '</tr>';
  }

  function addRow(preset){
    preset = preset || {};
    const id = String(Math.random()).slice(2,8);
    document.getElementById('allocBody').insertAdjacentHTML('beforeend', rowTemplate(id));

    if(preset.amt != null) document.getElementById('amt_'+id).value = fmtTRInput(preset.amt);
    if(preset.ccy) document.getElementById('ccy_'+id).value = preset.ccy;
    if(preset.prod) document.getElementById('prod_'+id).value = preset.prod;
    if(preset.rate != null) document.getElementById('rate_'+id).value = preset.rate;
    if(preset.method) document.getElementById('method_'+id).value = preset.method;
    if(preset.tax != null) document.getElementById('tax_'+id).value = preset.tax;
    if(preset.taxAuto != null) document.getElementById('taxAuto_'+id).checked = preset.taxAuto;

    applyDefaultsByProduct(id);
    document.getElementById('prod_'+id).addEventListener('change', function(){ applyDefaultsByProduct(id); });

    wireNumberFormatting(document.getElementById('amt_'+id));
  }

  function removeRow(id){
    const tr = document.querySelector('tr[data-id="'+id+'"]');
    if(tr) tr.remove();
  }

  function applyDefaultsByProduct(id){
    const prod = document.getElementById('prod_'+id).value;
    const rateEl = document.getElementById('rate_'+id);
    const methodEl = document.getElementById('method_'+id);
    const r = Number(rateEl.value)||0;

    if(prod==='TERM'){
      if(r===0) rateEl.value = 35;
      methodEl.value = 'SIMPLE';
    } else if(prod==='FUND'){
      if(r===0) rateEl.value = 45;
      methodEl.value = 'SIMPLE';
    } else if(prod==='SUKUK'){
      if(r===0) rateEl.value = 38;
      methodEl.value = 'SIMPLE';
    } else if(prod==='DPM'){
      if(r===0) rateEl.value = 12;
      methodEl.value = 'SIMPLE';
    }
  }

  // -------- Number formatting for inputs (dots, commas) --------
  function wireNumberFormatting(el){
    if(!el) return;
    el.addEventListener('blur', function(){
      const n = parseAmount(el.value);
      el.value = fmtTRInput(n);
    });
  }

  // -------- Calc --------
  function calc(){
    const warn = document.getElementById('warn');
    warn.textContent = '';

    autoFillEndRates();

    const principalAmt = parseAmount(document.getElementById('total_amount').value);
    const principalCcy = document.getElementById('total_ccy').value;
    const reportCcy = document.getElementById('report_ccy').value;

    if(principalAmt <= 0){ warn.textContent = 'Toplam varlık 0 olamaz.'; return; }

    const rows = Array.from(document.querySelectorAll('#allocBody tr'));
    if(rows.length === 0){ warn.textContent = 'En az 1 satır ekle.'; return; }

    const days = globalDays();
    if(days <= 0){ warn.textContent = 'Global vade 0 olamaz.'; return; }

    let usedPrincipal = 0;

    let totalEnd_report = 0;       // vade sonu toplam (rapor)
    let totalStart_report = 0;     // başlangıç toplam (rapor) - alokasyon bazlı
    let totalTax_report = 0;       // stopaj toplam (rapor)
    let totalEnd_principal = 0;    // vade sonu toplam (giriş PB)

    const byProductStartReport = { TERM:0, FUND:0, SUKUK:0, DPM:0 };

    for(const tr of rows){
      const id = tr.getAttribute('data-id');

      const amtBase = clamp(parseAmount(document.getElementById('amt_'+id).value));
      const prod = document.getElementById('prod_'+id).value;
      const targetCcy = document.getElementById('ccy_'+id).value;
      const rate = Number(document.getElementById('rate_'+id).value)||0;
      const method = document.getElementById('method_'+id).value;

      const taxAuto = (document.getElementById('taxAuto_'+id)?.checked) ? true : false;
      let taxPct = Number(document.getElementById('tax_'+id).value)||0;
      if(taxAuto){
        taxPct = suggestTaxPct(prod, targetCcy, days);
        document.getElementById('tax_'+id).value = taxPct;
      }

      usedPrincipal += amtBase;

      // principal -> target at START
      const r1 = fxRate(principalCcy, targetCcy, 'start');
      if(r1 === null){
        warn.textContent = 'Başlangıç kurları eksik. (USD/TRY, EUR/TRY, Altın/TRY kontrol et.)';
        return;
      }
      const P_target = amtBase * r1;

      // START value in report (for allocation donut + consistent P/L)
      const rStartToReport = fxRate(targetCcy, reportCcy, 'start');
      if(rStartToReport === null){
        warn.textContent = 'Başlangıç kurları eksik (rapor dönüşümü).';
        return;
      }
      const P_report_start = P_target * rStartToReport;
      totalStart_report += P_report_start;
      byProductStartReport[prod] = (byProductStartReport[prod]||0) + P_report_start;

      // growth in target
      const FV_target_gross = (method === 'DAILY_COMPOUND')
        ? fvDailyCompound(P_target, rate, days)
        : fvSimple(P_target, rate, days);

      const grossGain_target = FV_target_gross - P_target;
      const tax_target = grossGain_target * (taxPct/100);
      const netGain_target = grossGain_target - tax_target;
      const FV_target_net = P_target + netGain_target;

      // END conversions
      const rBack_end = fxRate(targetCcy, principalCcy, 'end');
      if(rBack_end === null){
        warn.textContent = 'Vade sonu kurları eksik. (Mode/Altın/Spot kontrol et.)';
        return;
      }
      const end_in_principal = FV_target_net * rBack_end;
      totalEnd_principal += end_in_principal;

      const rToReport_end = fxRate(targetCcy, reportCcy, 'end');
      if(rToReport_end === null){
        warn.textContent = 'Vade sonu kurları eksik (rapor dönüşümü).';
        return;
      }
      const FV_report_end = FV_target_net * rToReport_end;
      const tax_report_end = tax_target * rToReport_end;

      totalEnd_report += FV_report_end;
      totalTax_report += tax_report_end;

      document.getElementById('p_'+id).textContent  = fmtMoney(P_target, targetCcy);
      document.getElementById('fv_'+id).textContent = fmtMoney(FV_target_net, targetCcy);
      document.getElementById('net_'+id).textContent= fmtMoney(netGain_target, targetCcy);
    }

    document.getElementById('kpi_used').textContent = fmtMoney(usedPrincipal, principalCcy);
    document.getElementById('kpi_left').textContent = fmtMoney(principalAmt - usedPrincipal, principalCcy);

    if(usedPrincipal > principalAmt + 1e-9){
      warn.textContent = 'Alokasyon toplamı, toplam varlığı aşıyor. Satır tutarlarını düşür.';
    }

    // Consistent P/L in report currency:
    // Net P/L (report) = End total (report) - Start total (report)
    const pl_report = totalEnd_report - totalStart_report;

    document.getElementById('kpi_total_report').textContent = fmtMoney(totalEnd_report, reportCcy);
    document.getElementById('kpi_pl_report').textContent    = fmtMoney(pl_report, reportCcy);
    document.getElementById('kpi_tax_report').textContent   = fmtMoney(totalTax_report, reportCcy);
    document.getElementById('kpi_start_report').textContent = fmtMoney(totalStart_report, reportCcy);

    // Principal headline (in principal ccy)
    const pl_principal = totalEnd_principal - principalAmt;
    document.getElementById('headline_pl').textContent = fmtMoney(pl_principal, principalCcy);
    document.getElementById('headline_detail').textContent =
      'Başlangıç: '+fmtMoney(principalAmt, principalCcy)+' → Vade Sonu: '+fmtMoney(totalEnd_principal, principalCcy)+
      ' (Global vade: '+days.toFixed(0)+' gün)';

    document.getElementById('pillInfo').textContent = 'Principal: '+principalCcy+' | Rapor: '+reportCcy;

    // Vade sonu özet kutuları (sağ chart yerine)
    document.getElementById('end_total_principal').textContent = fmtMoney(totalEnd_principal, principalCcy);
    document.getElementById('end_total_report').textContent    = fmtMoney(totalEnd_report, reportCcy);
    document.getElementById('start_total_principal').textContent = fmtMoney(principalAmt, principalCcy);
    document.getElementById('start_total_report2').textContent   = fmtMoney(totalStart_report, reportCcy);

    // Risk/dağılım rozetleri (başlangıç rapor PB)
    const nameMap = { TERM:'Vadeli', FUND:'Fon', SUKUK:'Sukuk', DPM:'DPM' };
    const badgeEl = document.getElementById('risk_badges');
    if(totalStart_report > 0){
      const items = Object.keys(byProductStartReport)
        .map(k => ({k, v:byProductStartReport[k]}))
        .filter(x => x.v > 0)
        .sort((a,b)=>b.v-a.v)
        .map(x => '<span class="pill">'+nameMap[x.k]+': '+(x.v/totalStart_report*100).toFixed(1)+'%</span>')
        .join(' ');
      badgeEl.innerHTML = '<div class="mutedLine">Risk/Dağılım (ürün bazlı, başlangıç kurlarıyla):</div> '+items;
    } else badgeEl.textContent = '';

    // Donut + legend (başlangıç rapor PB)
    const labels=[], vals=[];
    Object.keys(byProductStartReport).forEach(k=>{
      if(byProductStartReport[k] > 0){
        labels.push(nameMap[k]);
        vals.push(byProductStartReport[k]);
      }
    });
    drawDonut(document.getElementById('pieStart'), labels, vals);

    const legend = labels.map((l,i)=>{
      const pct = (vals[i]/(totalStart_report||1))*100;
      return '<div style="margin:6px 0;"><b>'+l+'</b>: '+pct.toFixed(1)+'%</div>';
    }).join('');
    document.getElementById('pieLegend').innerHTML = legend;
  }

  // -------- Scenarios (allocate 100%) --------
  function applyScenario(weights){
    const totalAmount = parseAmount(document.getElementById('total_amount').value);
    const totalCcy = document.getElementById('total_ccy').value;
    document.getElementById('allocBody').innerHTML='';

    const sum = weights.reduce((a,x)=>a+(x.w||0), 0) || 1;
    const norm = weights.map(x => ({...x, w:(x.w||0)/sum}));

    let allocated = 0;
    for(let i=0;i<norm.length;i++){
      const it = norm[i];
      let amt = (i===norm.length-1) ? (totalAmount-allocated) : (totalAmount*it.w);
      amt = Math.max(0, amt);
      allocated += amt;

      addRow({
        amt: Number(amt.toFixed(2)),
        ccy: it.ccy,
        prod: it.prod,
        rate: it.rate,
        method: it.method,
        taxAuto: (it.taxAuto!=null) ? it.taxAuto : true,
        tax: (it.tax!=null) ? it.tax : 0
      });
    }

    document.getElementById('kpi_used').textContent = fmtMoney(totalAmount, totalCcy);
    document.getElementById('kpi_left').textContent = fmtMoney(0, totalCcy);
  }

  function scenario1(){ // Dengeli
    applyScenario([
      { w:0.25, ccy:'TL',  prod:'TERM',  rate:35, method:'SIMPLE', taxAuto:true },
      { w:0.45, ccy:'TL',  prod:'FUND',  rate:45, method:'SIMPLE', taxAuto:false, tax:0 },
      { w:0.20, ccy:'TL',  prod:'SUKUK', rate:38, method:'SIMPLE', taxAuto:false, tax:0 },
      { w:0.10, ccy:'USD', prod:'DPM',   rate:12, method:'SIMPLE', taxAuto:false, tax:0 }
    ]);
  }
  function scenario2(){ // Koruma
    applyScenario([
      { w:0.45, ccy:'TL',  prod:'TERM',  rate:35, method:'SIMPLE', taxAuto:true },
      { w:0.25, ccy:'TL',  prod:'SUKUK', rate:38, method:'SIMPLE', taxAuto:false, tax:0 },
      { w:0.20, ccy:'USD', prod:'SUKUK', rate:7,  method:'SIMPLE', taxAuto:false, tax:0 },
      { w:0.10, ccy:'USD', prod:'DPM',   rate:12, method:'SIMPLE', taxAuto:false, tax:0 }
    ]);
  }
  function scenario3(){ // Büyüme (Riskli)
    applyScenario([
      { w:0.15, ccy:'TL',  prod:'TERM',  rate:35, method:'SIMPLE', taxAuto:true },
      { w:0.55, ccy:'TL',  prod:'FUND',  rate:48, method:'SIMPLE', taxAuto:false, tax:0 },
      { w:0.20, ccy:'TL',  prod:'SUKUK', rate:38, method:'SIMPLE', taxAuto:false, tax:0 },
      { w:0.10, ccy:'USD', prod:'DPM',   rate:12, method:'SIMPLE', taxAuto:false, tax:0 }
    ]);
  }
  function scenario4(){ // FX Hedge
    applyScenario([
      { w:0.35, ccy:'USD', prod:'SUKUK', rate:7,  method:'SIMPLE', taxAuto:false, tax:0 },
      { w:0.35, ccy:'EUR', prod:'SUKUK', rate:6,  method:'SIMPLE', taxAuto:false, tax:0 },
      { w:0.15, ccy:'TL',  prod:'SUKUK', rate:38, method:'SIMPLE', taxAuto:false, tax:0 },
      { w:0.15, ccy:'TL',  prod:'FUND',  rate:45, method:'SIMPLE', taxAuto:false, tax:0 }
    ]);
  }
  function scenario5(){ // DPM Ağırlıklı
    applyScenario([
      { w:0.55, ccy:'USD', prod:'DPM',   rate:12, method:'SIMPLE', taxAuto:false, tax:0 },
      { w:0.20, ccy:'TL',  prod:'FUND',  rate:45, method:'SIMPLE', taxAuto:false, tax:0 },
      { w:0.15, ccy:'TL',  prod:'SUKUK', rate:38, method:'SIMPLE', taxAuto:false, tax:0 },
      { w:0.10, ccy:'TL',  prod:'TERM',  rate:35, method:'SIMPLE', taxAuto:true }
    ]);
  }

  // -------- Reset --------
  function resetAll(){
    document.getElementById('total_amount').value='1.000.000';
    document.getElementById('total_ccy').value='USD';
    document.getElementById('report_ccy').value='USD';
    document.getElementById('tenor_type').value='DAYS';
    document.getElementById('tenor_val').value='183';

    document.getElementById('xautry_g').value='0';
    document.getElementById('usdtry').value='0';
    document.getElementById('eurtry').value='0';

    document.getElementById('end_mode').value='SPOT';
    document.getElementById('gold_exp').value='0';

    document.getElementById('xautry_g_end').value='';
    document.getElementById('usdtry_end').value='';
    document.getElementById('eurtry_end').value='';

    document.getElementById('rtl').value='45';
    document.getElementById('rusd').value='5';
    document.getElementById('reur').value='3';

    document.getElementById('rate_status').textContent='';
    document.getElementById('warn').textContent='';
    document.getElementById('pillInfo').textContent='hazır';

    document.getElementById('headline_pl').textContent='-';
    document.getElementById('headline_detail').textContent='';
    document.getElementById('risk_badges').textContent='';

    document.getElementById('kpi_used').textContent='-';
    document.getElementById('kpi_left').textContent='-';
    document.getElementById('kpi_total_report').textContent='-';
    document.getElementById('kpi_pl_report').textContent='-';
    document.getElementById('kpi_tax_report').textContent='-';
    document.getElementById('kpi_start_report').textContent='-';

    document.getElementById('end_total_principal').textContent='-';
    document.getElementById('end_total_report').textContent='-';
    document.getElementById('start_total_principal').textContent='-';
    document.getElementById('start_total_report2').textContent='-';

    document.getElementById('allocBody').innerHTML='';
    addRow({ amt:0, ccy:'TL',  prod:'TERM', rate:35, method:'SIMPLE', taxAuto:true });
    addRow({ amt:0, ccy:'TL',  prod:'FUND', rate:45, method:'SIMPLE', taxAuto:false, tax:0 });

    setAmtHeader();
    document.getElementById('end_note').textContent = 'Spot = Vade Sonu: End kurlar spot ile aynı kabul edilir.';

    // wire formatting for top total too
    wireNumberFormatting(document.getElementById('total_amount'));
    document.getElementById('total_amount').dispatchEvent(new Event('blur'));
  }

  // -------- Wire --------
  document.getElementById('btn_calc').addEventListener('click', calc);
  document.getElementById('btn_reset').addEventListener('click', resetAll);
  document.getElementById('btn_rates').addEventListener('click', fetchRatesAll);
  document.getElementById('btn_fill_end').addEventListener('click', autoFillEndRates);

  document.getElementById('btn_use_manual').addEventListener('click', function(){
    const s = getStartRates();
    const ok = (s.usdtry>0 && s.eurtry>0) || (s.xautry_g>0);
    document.getElementById('rate_status').textContent = ok ? 'Manuel kur kullanılıyor.' : 'Manuel kur eksik.';
    autoFillEndRates();
  });

  document.getElementById('btn_add').addEventListener('click', function(){
    addRow({ amt:0, ccy:'TL', prod:'TERM', rate:35, method:'SIMPLE', taxAuto:true });
  });

  document.getElementById('btn_s1').addEventListener('click', scenario1);
  document.getElementById('btn_s2').addEventListener('click', scenario2);
  document.getElementById('btn_s3').addEventListener('click', scenario3);
  document.getElementById('btn_s4').addEventListener('click', scenario4);
  document.getElementById('btn_s5').addEventListener('click', scenario5);

  document.getElementById('total_ccy').addEventListener('change', setAmtHeader);

  document.getElementById('end_mode').addEventListener('change', autoFillEndRates);
  document.getElementById('tenor_type').addEventListener('change', autoFillEndRates);
  document.getElementById('tenor_val').addEventListener('input', autoFillEndRates);
  document.getElementById('rtl').addEventListener('input', autoFillEndRates);
  document.getElementById('rusd').addEventListener('input', autoFillEndRates);
  document.getElementById('reur').addEventListener('input', autoFillEndRates);
  document.getElementById('gold_exp').addEventListener('input', autoFillEndRates);

  // top input formatting
  wireNumberFormatting(document.getElementById('total_amount'));

  resetAll();
</script>
</body>
</html>
