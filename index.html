<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PB Allocation Engine – Roadshow</title>

  <meta name="theme-color" content="#0b1a2a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --ink:#0b1a2a; --muted:#5b6777;
      --line:#e6e9f2; --accent:#c8a33a; --accent2:#123a63;
      --danger:#9b1c1c;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background:var(--bg); color:var(--ink);
    }
    header{
      padding:16px 14px 10px;
      background:linear-gradient(180deg,#fff 0%, #f6f7fb 100%);
      border-bottom:1px solid var(--line);
      position:sticky; top:0; z-index:10;
    }
    h1{margin:0; font-size:16px; letter-spacing:.2px}
    .sub{margin-top:6px; color:var(--muted); font-size:12.5px; line-height:1.35}
    .wrap{max-width:1240px; margin:0 auto; padding:12px 12px 26px}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow:0 6px 18px rgba(12,26,43,.06);
    }
    .card h2{margin:0 0 10px; font-size:13px; color:var(--accent2); letter-spacing:.2px}

    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      font-size:14px;
      background:#fff;
    }
    input:focus, select:focus{
      border-color: rgba(18,58,99,.35);
      box-shadow: 0 0 0 4px rgba(18,58,99,.08);
    }

    .topbar{display:flex; gap:12px; flex-wrap:wrap; align-items:stretch;}
    .topcol{flex:1; min-width:260px;}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}

    .btns{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    button{border:none; border-radius:12px; padding:12px 12px; font-size:14px; cursor:pointer;}
    .primary{background:var(--accent2); color:#fff}
    .ghost{background:#fff; border:1px solid var(--line); color:var(--ink)}
    .danger{background:rgba(155,28,28,.08); border:1px solid rgba(155,28,28,.22); color:var(--danger)}
    .small{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.35}
    .pill{
      display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px;
      background: rgba(200,163,58,.12); color:#6a5207; border:1px solid rgba(200,163,58,.25);
      margin-right:6px; margin-top:6px;
    }

    .tableWrap{
      width:100%;
      overflow-x:auto;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      margin-top:10px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:1240px;
      font-size:13px;
    }
    th, td{padding:10px 8px; border-bottom:1px solid var(--line); text-align:left; vertical-align:middle}
    th{font-size:12px; color:var(--muted); font-weight:600}

    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .kpi .box{border:1px solid var(--line); border-radius:14px; padding:12px; background:#fff}
    .kpi .t{color:var(--muted); font-size:12px}
    .kpi .v{margin-top:6px; font-size:18px; font-weight:780; letter-spacing:.2px}

    canvas{width:100%; height:260px; border-radius:14px; border:1px solid var(--line); background:#fff;}

    .watermark{
      position:fixed; right:10px; bottom:10px;
      font-size:11px; color:rgba(11,26,42,.40);
      background:rgba(255,255,255,.75);
      border:1px solid rgba(230,233,242,.9);
      padding:6px 10px; border-radius:999px;
      backdrop-filter: blur(6px);
    }
    .inlineWarn{margin-top:10px; font-size:12px; color:var(--danger)}
    .mutedLine{margin-top:6px; font-size:12px; color:var(--muted)}

    .miniBtn{
      padding:8px 10px; border-radius:10px;
      border:1px solid var(--line); background:#fff; cursor:pointer;
      font-size:12px;
    }

    .wAmt{min-width:140px}
    .wCcy{min-width:100px}
    .wProd{min-width:150px}
    .wRate{min-width:110px}
    .wTenor{min-width:170px}
    .wCalc{min-width:220px}
    .wTax{min-width:160px}
    .wBtn{min-width:70px}

    .taxWrap{display:flex; gap:8px; align-items:center;}
    .taxWrap label{display:flex; gap:6px; align-items:center; margin:0; font-size:12px; color:var(--muted); white-space:nowrap;}
    .taxWrap input[type="checkbox"]{width:auto; padding:0; margin:0; transform: translateY(1px);}
  </style>
</head>

<body>
<header>
  <h1>PB Allocation Engine <span class="pill">Roadshow</span></h1>
  <div class="sub">Toplam varlık → alokasyon → ürün/vade/oran/stopaj → kur → sonuç.</div>
</header>

<div class="wrap">

  <div class="card">
    <div class="topbar">
      <div class="topcol">
        <h2>1) Müşteri Varlığı</h2>
        <label>Toplam Varlık</label>
        <input id="total_amount" type="text" inputmode="decimal" value="1,000,000" />

        <div class="row">
          <div>
            <label>Toplam Varlık Para Birimi</label>
            <select id="total_ccy">
              <option value="USD" selected>USD</option>
              <option value="TL">TL</option>
              <option value="EUR">EUR</option>
            </select>
          </div>
          <div>
            <label>Rapor Para Birimi</label>
            <select id="report_ccy">
              <option value="TL" selected>TL</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
            </select>
          </div>
        </div>
      </div>

      <div class="topcol">
        <h2>2) Kurlar</h2>
        <div class="row3">
          <div>
            <label>Altın (gram/TRY)</label>
            <input id="xautry_g" type="number" step="0.01" value="0" />
          </div>
          <div>
            <label>USD/TRY</label>
            <input id="usdtry" type="number" step="0.0001" value="0" />
          </div>
          <div>
            <label>EUR/TRY</label>
            <input id="eurtry" type="number" step="0.0001" value="0" />
          </div>
        </div>

        <div class="btns">
          <button class="ghost" id="btn_rates">Kurları Çek</button>
          <button class="ghost" id="btn_use_manual">Manuel Kur Kullan</button>
        </div>
        <div id="rate_status" class="mutedLine"></div>
        <div class="small">Önce Trunçgil denenir; tarayıcı engellerse USD/EUR için alternatif kaynağa düşer.</div>
      </div>

      <div class="topcol">
        <h2>3) Hızlı Aksiyonlar</h2>
        <div class="btns">
          <button class="primary" id="btn_calc" style="flex:1;">Hesapla</button>
          <button class="danger" id="btn_reset" style="flex:1;">Sıfırla</button>
        </div>
        <div class="small">Senaryo seçince toplam varlığın %100’ü dağıtılır.</div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <h2>Alokasyon (Tutar Bazlı) <span class="pill" id="pillInfo">hazır</span></h2>

    <div class="kpi" style="grid-template-columns:1fr; margin-top:12px;">
      <div class="box">
        <div class="t">Headline – Toplam Net Kazanç (Rapor PB)</div>
        <div class="v" id="headline_gain">-</div>
      </div>
    </div>

    <div id="risk_badges" class="small" style="margin-top:8px;"></div>

    <div class="btns" style="margin-top:10px;">
      <button class="ghost" id="btn_add">+ Satır Ekle</button>
      <button class="ghost" id="btn_s1">Senaryo 1</button>
      <button class="ghost" id="btn_s2">Senaryo 2</button>
      <button class="ghost" id="btn_s3">Senaryo 3</button>
      <button class="ghost" id="btn_s4">Senaryo 4</button>
      <button class="ghost" id="btn_s5">Senaryo 5</button>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th class="wAmt">Tutar (Toplam PB)</th>
            <th class="wCcy">Hedef PB</th>
            <th class="wProd">Ürün</th>
            <th class="wRate">Yıllık %</th>
            <th class="wTenor">Vade</th>
            <th class="wCalc">Hesap</th>
            <th class="wTax">Stopaj</th>
            <th>Anapara</th>
            <th>Vade Sonu</th>
            <th>Net Kazanç</th>
            <th class="wBtn"></th>
          </tr>
        </thead>
        <tbody id="allocBody"></tbody>
      </table>
    </div>

    <div class="kpi">
      <div class="box">
        <div class="t">Toplam Kullanılan Tutar (Toplam PB)</div>
        <div class="v" id="kpi_used">-</div>
      </div>
      <div class="box">
        <div class="t">Kalan Tutar (Toplam PB)</div>
        <div class="v" id="kpi_left">-</div>
      </div>
    </div>

    <div class="kpi">
      <div class="box">
        <div class="t">Portföy Toplamı (Rapor PB)</div>
        <div class="v" id="kpi_total">-</div>
      </div>
      <div class="box">
        <div class="t">Net Kazanç (Rapor PB)</div>
        <div class="v" id="kpi_gain">-</div>
      </div>
    </div>

    <div style="margin-top:12px;">
      <canvas id="chart" width="1200" height="300"></canvas>
      <div class="small">Grafik: Satır bazında net kazanç (rapor PB)</div>
    </div>

    <div id="warn" class="inlineWarn"></div>
  </div>

</div>

<div class="watermark">Adem Soyer</div>

<script>
  // ---- Helpers
  function parseAmount(str){
    if(!str) return 0;
    let s = String(str).trim().replace(/\s/g,'');
    if(s.includes(',') && s.includes('.')) s = s.replace(/[.,]/g,'');
    else s = s.replace(/,/g,'').replace(/\./g,'');
    const n = Number(s);
    return isFinite(n) ? n : 0;
  }
  function fmtMoney(n, ccy){
    const abs = Math.abs(n);
    const opts = abs >= 100000 ? { maximumFractionDigits: 0 } : { maximumFractionDigits: 2 };
    return new Intl.NumberFormat('tr-TR', opts).format(n) + ' ' + ccy;
  }
  function clamp(x){ return Math.max(0, Number(x)||0); }

  // ---- FX
  function getFx(){
    return {
      usdtry: Number(document.getElementById('usdtry').value)||0,
      eurtry: Number(document.getElementById('eurtry').value)||0
    };
  }
  function fxRate(from, to){
    if(from === to) return 1;
    const { usdtry, eurtry } = getFx();
    if(usdtry<=0 || eurtry<=0) return null;

    const toTRY = (ccy)=>{
      if(ccy==='TL') return 1;
      if(ccy==='USD') return usdtry;
      if(ccy==='EUR') return eurtry;
      return null;
    }
    const fromTRY = (ccy)=>{
      if(ccy==='TL') return 1;
      if(ccy==='USD') return 1/usdtry;
      if(ccy==='EUR') return 1/eurtry;
      return null;
    }
    const a = toTRY(from);
    const b = fromTRY(to);
    if(a==null || b==null) return null;
    return a*b;
  }

  // ---- Rate fetch (Trunçgil + fallback)
  async function fetchRatesAll(){
    const status = document.getElementById('rate_status');
    status.textContent = 'Kurlar çekiliyor…';

    // 1) Try Trunçgil (may fail due to CORS)
    try{
      const res = await fetch('https://finans.truncgil.com/v4/today.json', { cache:'no-store' });
      if(res.ok){
        const data = await res.json();
        const usd = data?.USD?.Selling ?? data?.USD?.Buying;
        const eur = data?.EUR?.Selling ?? data?.EUR?.Buying;
        const gra = data?.GRA?.Selling ?? data?.GRA?.Buying;
        if(usd && eur){
          document.getElementById('usdtry').value = Number(usd).toFixed(4);
          document.getElementById('eurtry').value = Number(eur).toFixed(4);
          if(gra) document.getElementById('xautry_g').value = Number(gra).toFixed(2);
          status.textContent = 'Trunçgil: USD/EUR/Altın güncellendi.';
          return;
        }
      }
    }catch(e){
      // ignore, go fallback
    }

    // 2) Fallback: open.er-api for USD/EUR (works with CORS)
    try{
      const r = await fetch('https://open.er-api.com/v6/latest/TRY', { cache:'no-store' });
      if(!r.ok) throw new Error('fallback failed');
      const j = await r.json();
      // TRY base => USD = 1/ (USDTRY). But we want USDTRY, so invert
      const usd = j?.rates?.USD;
      const eur = j?.rates?.EUR;
      if(usd && eur){
        document.getElementById('usdtry').value = (1/Number(usd)).toFixed(4);
        document.getElementById('eurtry').value = (1/Number(eur)).toFixed(4);
        status.textContent = 'Trunçgil engellendi. USD/EUR alternatif kaynaktan güncellendi. Altın manuel.';
        return;
      }
      throw new Error('rates missing');
    }catch(e2){
      status.textContent = 'Kurlar çekilemedi. Manuel girip devam edebilirsin.';
    }
  }

  // ---- Math
  function fvSimple(P, annualPct, days){
    const r = (Number(annualPct)||0)/100;
    return P * (1 + r * (days/365));
  }
  function fvDailyCompound(P, annualPct, days){
    const r = (Number(annualPct)||0)/100;
    return P * Math.pow(1 + r/365, days);
  }
  function daysFromInput(vType, vVal){
    const n = clamp(vVal);
    return (vType==='DAYS') ? n : (n * 30.4375);
  }

  // ---- Stopaj (Auto)
  function suggestTaxPct(prod, targetCcy, vType, vVal){
    const days = daysFromInput(vType, vVal);
    if(prod === 'TERM'){
      if(targetCcy !== 'TL') return 25;
      if(days <= 183) return 17.5;
      if(days <= 365) return 15;
      return 10;
    }
    return 0;
  }

  // ---- Chart
  function drawBarChart(canvas, labels, values){
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);

    const padL = 70, padR = 20, padT = 20, padB = 50;
    const chartW = W - padL - padR;
    const chartH = H - padT - padB;

    ctx.strokeStyle = '#e6e9f2';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, padT + chartH);
    ctx.lineTo(padL + chartW, padT + chartH);
    ctx.stroke();

    const maxV = Math.max(...values.map(v=>Math.abs(v)), 1);
    const barGap = 16;
    const barW = (chartW - barGap*(values.length+1)) / Math.max(values.length,1);

    const ticks = 4;
    ctx.fillStyle = '#5b6777';
    ctx.font = '12px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial';
    for(let i=0;i<=ticks;i++){
      const y = padT + chartH - (chartH * i / ticks);
      ctx.strokeStyle = 'rgba(230,233,242,.9)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padL, y);
      ctx.lineTo(padL + chartW, y);
      ctx.stroke();
      const tickVal = Math.round(maxV * i / ticks);
      ctx.fillText(tickVal.toLocaleString('tr-TR'), 10, y+4);
    }

    for(let i=0;i<values.length;i++){
      const v = values[i];
      const h = (Math.abs(v) / maxV) * chartH;
      const x = padL + barGap + i*(barW + barGap);
      const y = padT + chartH - h;

      ctx.fillStyle = (v>=0) ? 'rgba(18,58,99,.88)' : 'rgba(155,28,28,.70)';
      ctx.fillRect(x, y, barW, h);

      ctx.fillStyle = 'rgba(200,163,58,.95)';
      ctx.fillRect(x, y, barW, 4);

      ctx.fillStyle = '#0b1a2a';
      ctx.font = '12px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial';
      const lab = labels[i];
      const labX = x + barW/2 - (ctx.measureText(lab).width/2);
      ctx.fillText(lab, labX, padT + chartH + 28);
    }
  }

  // ---- Rows
  const PRODUCT_OPTIONS = [
    { val:'TERM', label:'Vadeli Mevduat' },
    { val:'FUND', label:'Yatırım Fonu' },
    { val:'SUKUK', label:'Sukuk' },
    { val:'DPM',  label:'DPM' }
  ];

  function rowTemplate(id){
    const prodOpts = PRODUCT_OPTIONS.map(o=>`<option value="${o.val}">${o.label}</option>`).join('');
    return `
      <tr data-id="${id}">
        <td class="wAmt"><input type="number" step="0.01" id="amt_${id}" value="0"></td>
        <td class="wCcy">
          <select id="ccy_${id}">
            <option value="TL">TL</option>
            <option value="USD" selected>USD</option>
            <option value="EUR">EUR</option>
          </select>
        </td>
        <td class="wProd">
          <select id="prod_${id}">${prodOpts}</select>
        </td>
        <td class="wRate"><input type="number" step="0.01" id="rate_${id}" value="0"></td>
        <td class="wTenor">
          <div style="display:flex; gap:8px;">
            <select id="vtype_${id}" style="flex:1;">
              <option value="DAYS" selected>Gün</option>
              <option value="MONTHS">Ay</option>
            </select>
            <input type="number" step="1" id="v_${id}" value="32" style="flex:1;">
          </div>
        </td>
        <td class="wCalc">
          <select id="method_${id}">
            <option value="DAILY_COMPOUND" selected>Günlük (bileşik)</option>
            <option value="SIMPLE">Basit</option>
          </select>
        </td>
        <td class="wTax">
          <div class="taxWrap">
            <input type="number" step="0.01" id="tax_${id}" value="0" style="flex:1;">
            <label><input type="checkbox" id="taxAuto_${id}" checked>Auto</label>
          </div>
        </td>
        <td id="p_${id}">-</td>
        <td id="fv_${id}">-</td>
        <td id="net_${id}">-</td>
        <td class="wBtn"><button class="miniBtn" onclick="removeRow('${id}')">Sil</button></td>
      </tr>
    `;
  }

  function addRow(preset={}){
    const id = String(Math.random()).slice(2,8);
    document.getElementById('allocBody').insertAdjacentHTML('beforeend', rowTemplate(id));

    if(preset.amt != null) document.getElementById(`amt_${id}`).value = preset.amt;
    if(preset.ccy) document.getElementById(`ccy_${id}`).value = preset.ccy;
    if(preset.prod) document.getElementById(`prod_${id}`).value = preset.prod;
    if(preset.rate != null) document.getElementById(`rate_${id}`).value = preset.rate;
    if(preset.vtype) document.getElementById(`vtype_${id}`).value = preset.vtype;
    if(preset.v != null) document.getElementById(`v_${id}`).value = preset.v;
    if(preset.method) document.getElementById(`method_${id}`).value = preset.method;
    if(preset.tax != null) document.getElementById(`tax_${id}`).value = preset.tax;
    if(preset.taxAuto != null) document.getElementById(`taxAuto_${id}`).checked = preset.taxAuto;

    applyDefaultsByProduct(id);
    document.getElementById(`prod_${id}`).addEventListener('change', ()=>applyDefaultsByProduct(id));
  }

  function removeRow(id){
    const tr = document.querySelector(`tr[data-id="${id}"]`);
    if(tr) tr.remove();
  }

  function applyDefaultsByProduct(id){
    const prod = document.getElementById(`prod_${id}`).value;
    const rateEl = document.getElementById(`rate_${id}`);
    const vEl = document.getElementById(`v_${id}`);
    const vTypeEl = document.getElementById(`vtype_${id}`);
    const methodEl = document.getElementById(`method_${id}`);

    const r = Number(rateEl.value)||0;

    if(prod==='TERM'){
      if(r===0) rateEl.value = 35;
      methodEl.value = 'DAILY_COMPOUND';
      if((Number(vEl.value)||0)===0){ vTypeEl.value='DAYS'; vEl.value=32; }
    }else if(prod==='FUND'){
      if(r===0) rateEl.value = 42;
      methodEl.value = 'DAILY_COMPOUND';
      if((Number(vEl.value)||0)===0){ vTypeEl.value='DAYS'; vEl.value=32; }
    }else if(prod==='SUKUK'){
      if(r===0) rateEl.value = 38;
      methodEl.value = 'SIMPLE';
      if((Number(vEl.value)||0)===0){ vTypeEl.value='MONTHS'; vEl.value=12; }
    }else if(prod==='DPM'){
      if(r===0) rateEl.value = 18;
      methodEl.value = 'DAILY_COMPOUND';
      if((Number(vEl.value)||0)===0){ vTypeEl.value='DAYS'; vEl.value=180; }
    }
  }

  // ---- Calc
  function calc(){
    const warn = document.getElementById('warn');
    warn.textContent = '';

    const totalAmount = parseAmount(document.getElementById('total_amount').value);
    const totalCcy = document.getElementById('total_ccy').value;
    const reportCcy = document.getElementById('report_ccy').value;

    if(totalAmount <= 0){ warn.textContent = 'Toplam varlık 0 olamaz.'; return; }

    const rows = Array.from(document.querySelectorAll('#allocBody tr'));
    if(rows.length === 0){ warn.textContent = 'En az 1 satır ekle.'; return; }

    if(fxRate('USD','TL') === null){
      warn.textContent = 'Kur eksik: USD/TRY ve EUR/TRY gir veya kurları çek.';
      return;
    }

    let usedTotalCcy = 0;
    let totalFV_report = 0;
    let totalNetGain_report = 0;

    const chartLabels = [];
    const chartValues = [];

    const byProductReport = { TERM:0, FUND:0, SUKUK:0, DPM:0 };
    let totalPrincipalReport = 0;

    for(const tr of rows){
      const id = tr.getAttribute('data-id');

      const amtBase = clamp(document.getElementById(`amt_${id}`).value);
      const targetCcy = document.getElementById(`ccy_${id}`).value;
      const prod = document.getElementById(`prod_${id}`).value;
      const rate = Number(document.getElementById(`rate_${id}`).value)||0;
      const vType = document.getElementById(`vtype_${id}`).value;
      const vVal = Number(document.getElementById(`v_${id}`).value)||0;
      const method = document.getElementById(`method_${id}`).value;

      const taxAuto = document.getElementById(`taxAuto_${id}`)?.checked ?? false;
      let taxPct = Number(document.getElementById(`tax_${id}`).value)||0;
      if(taxAuto){
        taxPct = suggestTaxPct(prod, targetCcy, vType, vVal);
        document.getElementById(`tax_${id}`).value = taxPct;
      }

      usedTotalCcy += amtBase;

      const r1 = fxRate(totalCcy, targetCcy);
      if(r1 === null){ warn.textContent='Kur dönüşümü yapılamadı.'; return; }
      const P_target = amtBase * r1;

      const rP = fxRate(targetCcy, reportCcy);
      if(rP === null){ warn.textContent='Kur dönüşümü yapılamadı.'; return; }
      const P_rep = P_target * rP;
      totalPrincipalReport += P_rep;
      byProductReport[prod] = (byProductReport[prod]||0) + P_rep;

      const days = daysFromInput(vType, vVal);

      const FV_target = (method === 'DAILY_COMPOUND')
        ? fvDailyCompound(P_target, rate, days)
        : fvSimple(P_target, rate, days);

      const grossGain_target = FV_target - P_target;
      const tax_target = grossGain_target * (taxPct/100);
      const netGain_target = grossGain_target - tax_target;
      const netFV_target = P_target + netGain_target;

      const FV_rep = netFV_target * rP;
      const netGain_rep = netGain_target * rP;

      totalFV_report += FV_rep;
      totalNetGain_report += netGain_rep;

      document.getElementById(`p_${id}`).textContent  = fmtMoney(P_target, targetCcy);
      document.getElementById(`fv_${id}`).textContent = fmtMoney(netFV_target, targetCcy);
      document.getElementById(`net_${id}`).textContent= fmtMoney(netGain_target, targetCcy);

      const prodLabel = (prod==='TERM'?'Vadeli':prod==='FUND'?'Fon':prod==='SUKUK'?'Sukuk':'DPM');
      chartLabels.push(`${prodLabel}-${targetCcy}`);
      chartValues.push(netGain_rep);
    }

    document.getElementById('kpi_used').textContent = fmtMoney(usedTotalCcy, totalCcy);
    document.getElementById('kpi_left').textContent = fmtMoney(totalAmount - usedTotalCcy, totalCcy);

    document.getElementById('kpi_total').textContent = fmtMoney(totalFV_report, reportCcy);
    document.getElementById('kpi_gain').textContent = fmtMoney(totalNetGain_report, reportCcy);
    document.getElementById('headline_gain').textContent = fmtMoney(totalNetGain_report, reportCcy);

    document.getElementById('pillInfo').textContent = `Toplam: ${fmtMoney(totalAmount,totalCcy)} → Rapor: ${reportCcy}`;

    const nameMap = { TERM:'Vadeli', FUND:'Fon', SUKUK:'Sukuk', DPM:'DPM' };
    const badgeEl = document.getElementById('risk_badges');
    if(totalPrincipalReport>0){
      const items = Object.keys(byProductReport)
        .map(k=>({k,v:byProductReport[k]}))
        .filter(x=>x.v>0)
        .sort((a,b)=>b.v-a.v)
        .map(x=>`<span class="pill">${nameMap[x.k]}: ${(x.v/totalPrincipalReport*100).toFixed(1)}%</span>`)
        .join(' ');
      badgeEl.innerHTML = `<div class="mutedLine">Risk/Dağılım (ürün bazlı):</div> ${items}`;
    }else{
      badgeEl.textContent='';
    }

    drawBarChart(document.getElementById('chart'), chartLabels, chartValues);
  }

  // ---- Scenarios
  function applyScenario(weights){
    const totalAmount = parseAmount(document.getElementById('total_amount').value);
    const totalCcy = document.getElementById('total_ccy').value;
    document.getElementById('allocBody').innerHTML='';

    const sum = weights.reduce((a,x)=>a+(x.w||0),0) || 1;
    const norm = weights.map(x=>({ ...x, w:(x.w||0)/sum }));

    let allocated = 0;
    for(let i=0;i<norm.length;i++){
      const it = norm[i];
      let amt = (i===norm.length-1) ? (totalAmount-allocated) : (totalAmount*it.w);
      amt = Math.max(0, amt);
      allocated += amt;

      addRow({
        amt: Number(amt.toFixed(2)),
        ccy: it.ccy, prod: it.prod, rate: it.rate,
        vtype: it.vtype, v: it.v, method: it.method,
        taxAuto: it.taxAuto ?? true, tax: it.tax ?? 0
      });
    }
    document.getElementById('kpi_used').textContent = fmtMoney(totalAmount, totalCcy);
    document.getElementById('kpi_left').textContent = fmtMoney(0, totalCcy);
  }

  function scenario1(){ applyScenario([
    { w:0.25, ccy:'TL',  prod:'TERM',  rate:35, vtype:'DAYS',   v:32,  method:'DAILY_COMPOUND', taxAuto:true },
    { w:0.25, ccy:'TL',  prod:'FUND',  rate:42, vtype:'DAYS',   v:32,  method:'DAILY_COMPOUND', taxAuto:false, tax:0 },
    { w:0.25, ccy:'TL',  prod:'SUKUK', rate:38, vtype:'MONTHS', v:12,  method:'SIMPLE',         taxAuto:false, tax:0 },
    { w:0.25, ccy:'USD', prod:'DPM',   rate:10, vtype:'DAYS',   v:180, method:'DAILY_COMPOUND', taxAuto:false, tax:0 },
  ]);}

  function scenario2(){ applyScenario([
    { w:0.40, ccy:'TL',  prod:'TERM',  rate:35, vtype:'DAYS',   v:32,  method:'DAILY_COMPOUND', taxAuto:true },
    { w:0.30, ccy:'TL',  prod:'SUKUK', rate:38, vtype:'MONTHS', v:12,  method:'SIMPLE',         taxAuto:false, tax:0 },
    { w:0.20, ccy:'USD', prod:'SUKUK', rate:7,  vtype:'MONTHS', v:12,  method:'SIMPLE',         taxAuto:false, tax:0 },
    { w:0.10, ccy:'USD', prod:'DPM',   rate:10, vtype:'DAYS',   v:180, method:'DAILY_COMPOUND', taxAuto:false, tax:0 },
  ]);}

  function scenario3(){ applyScenario([
    { w:0.20, ccy:'TL',  prod:'TERM',  rate:35, vtype:'DAYS',   v:32,  method:'DAILY_COMPOUND', taxAuto:true },
    { w:0.40, ccy:'TL',  prod:'FUND',  rate:45, vtype:'DAYS',   v:32,  method:'DAILY_COMPOUND', taxAuto:false, tax:0 },
    { w:0.20, ccy:'TL',  prod:'SUKUK', rate:38, vtype:'MONTHS', v:12,  method:'SIMPLE',         taxAuto:false, tax:0 },
    { w:0.20, ccy:'USD', prod:'DPM',   rate:12, vtype:'DAYS',   v:180, method:'DAILY_COMPOUND', taxAuto:false, tax:0 },
  ]);}

  function scenario4(){ applyScenario([
    { w:0.30, ccy:'USD', prod:'SUKUK', rate:7,  vtype:'MONTHS', v:12, method:'SIMPLE', taxAuto:false, tax:0 },
    { w:0.30, ccy:'EUR', prod:'SUKUK', rate:6,  vtype:'MONTHS', v:12, method:'SIMPLE', taxAuto:false, tax:0 },
    { w:0.20, ccy:'TL',  prod:'SUKUK', rate:38, vtype:'MONTHS', v:12, method:'SIMPLE', taxAuto:false, tax:0 },
    { w:0.20, ccy:'TL',  prod:'FUND',  rate:42, vtype:'DAYS',   v:32, method:'DAILY_COMPOUND', taxAuto:false, tax:0 },
  ]);}

  function scenario5(){ applyScenario([
    { w:0.50, ccy:'USD', prod:'DPM',   rate:12, vtype:'DAYS',   v:180, method:'DAILY_COMPOUND', taxAuto:false, tax:0 },
    { w:0.20, ccy:'TL',  prod:'FUND',  rate:42, vtype:'DAYS',   v:32,  method:'DAILY_COMPOUND', taxAuto:false, tax:0 },
    { w:0.20, ccy:'TL',  prod:'SUKUK', rate:38, vtype:'MONTHS', v:12,  method:'SIMPLE',         taxAuto:false, tax:0 },
    { w:0.10, ccy:'TL',  prod:'TERM',  rate:35, vtype:'DAYS',   v:32,  method:'DAILY_COMPOUND', taxAuto:true },
  ]);}

  // ---- Reset & Wire
  function resetAll(){
    document.getElementById('total_amount').value='1,000,000';
    document.getElementById('total_ccy').value='USD';
    document.getElementById('report_ccy').value='TL';
    document.getElementById('xautry_g').value='0';
    document.getElementById('usdtry').value='0';
    document.getElementById('eurtry').value='0';
    document.getElementById('rate_status').textContent='';
    document.getElementById('warn').textContent='';
    document.getElementById('pillInfo').textContent='hazır';
    document.getElementById('headline_gain').textContent='-';
    document.getElementById('risk_badges').textContent='';
    document.getElementById('kpi_used').textContent='-';
    document.getElementById('kpi_left').textContent='-';
    document.getElementById('kpi_total').textContent='-';
    document.getElementById('kpi_gain').textContent='-';
    document.getElementById('allocBody').innerHTML='';
    addRow({ amt:0, ccy:'TL', prod:'TERM', rate:35, vtype:'DAYS', v:32, method:'DAILY_COMPOUND', taxAuto:true });
    addRow({ amt:0, ccy:'TL', prod:'FUND', rate:42, vtype:'DAYS', v:32, method:'DAILY_COMPOUND', taxAuto:false, tax:0 });
    const ctx = document.getElementById('chart').getContext('2d');
    ctx.clearRect(0,0,1200,300);
  }

  document.getElementById('btn_calc').addEventListener('click', calc);
  document.getElementById('btn_reset').addEventListener('click', resetAll);
  document.getElementById('btn_rates').addEventListener('click', fetchRatesAll);
  document.getElementById('btn_use_manual').addEventListener('click', ()=>{
    const { usdtry, eurtry } = getFx();
    document.getElementById('rate_status').textContent =
      (usdtry>0 && eurtry>0) ? 'Manuel kur kullanılıyor.' : 'Manuel kur eksik: USD/TRY ve EUR/TRY gir.';
  });

  document.getElementById('btn_add').addEventListener('click', ()=>addRow({ amt:0, ccy:'TL', prod:'TERM', rate:35, vtype:'DAYS', v:32, method:'DAILY_COMPOUND', taxAuto:true }));
  document.getElementById('btn_s1').addEventListener('click', scenario1);
  document.getElementById('btn_s2').addEventListener('click', scenario2);
  document.getElementById('btn_s3').addEventListener('click', scenario3);
  document.getElementById('btn_s4').addEventListener('click', scenario4);
  document.getElementById('btn_s5').addEventListener('click', scenario5);

  resetAll();
</script>
</body>
</html>
