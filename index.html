<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PB Allocation Engine – Roadshow</title>

  <meta name="theme-color" content="#123a63">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --ink:#0b1a2a; --muted:#5b6777;
      --line:#e6e9f2; --accent:#c8a33a; --accent2:#123a63;
      --danger:#9b1c1c;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background:var(--bg); color:var(--ink);
    }
    header{
      padding:14px 14px 10px;
      background:linear-gradient(180deg,#fff 0%, #f6f7fb 100%);
      border-bottom:1px solid var(--line);
      position:sticky; top:0; z-index:10;
    }
    .headTop{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      flex-wrap:wrap;
    }
    h1{margin:0; font-size:16px; letter-spacing:.2px}
    .sub{margin-top:6px; color:var(--muted); font-size:12.5px; line-height:1.35}
    .wrap{max-width:1240px; margin:0 auto; padding:12px 12px 26px}

    .headRight{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .buildTag{
      font-size:12px; color:rgba(11,26,42,.62);
      border:1px solid var(--line);
      background:#fff;
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }
    .langSel{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background:#fff;
      padding:6px 10px;
      border-radius:999px;
    }
    .langSel label{margin:0; font-size:12px; color:var(--muted); white-space:nowrap;}
    .langSel select{
      width:auto; padding:6px 8px; border-radius:10px; font-size:12px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow:0 6px 18px rgba(12,26,43,.06);
    }
    .card h2{margin:0 0 10px; font-size:13px; color:var(--accent2); letter-spacing:.2px}

    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      font-size:14px;
      background:#fff;
    }
    input:focus, select:focus{
      border-color: rgba(18,58,99,.35);
      box-shadow: 0 0 0 4px rgba(18,58,99,.08);
    }

    .topbar{display:flex; gap:12px; flex-wrap:wrap; align-items:stretch;}
    .topcol{flex:1; min-width:260px;}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}

    .btns{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    .btns.scroller{flex-wrap:nowrap; overflow-x:auto; padding-bottom:6px}
    .btns.scroller::-webkit-scrollbar{height:6px}
    .btns.scroller::-webkit-scrollbar-thumb{background:#d9deea; border-radius:999px}
    button{border:none; border-radius:12px; padding:12px 12px; font-size:14px; cursor:pointer; white-space:nowrap}
    .primary{background:var(--accent2); color:#fff}
    .ghost{background:#fff; border:1px solid var(--line); color:var(--ink)}
    .danger{background:rgba(155,28,28,.08); border:1px solid rgba(155,28,28,.22); color:var(--danger)}
    .small{font-size:12px; color:var(--muted); margin-top:8px; line-height:1.35}
    .pill{
      display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px;
      background: rgba(200,163,58,.12); color:#6a5207; border:1px solid rgba(200,163,58,.25);
      margin-right:6px; margin-top:6px;
    }

    .tableWrap{
      width:100%;
      overflow-x:auto;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      margin-top:10px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:1200px;
      font-size:13px;
    }
    th, td{padding:10px 8px; border-bottom:1px solid var(--line); text-align:left; vertical-align:middle}
    th{font-size:12px; color:var(--muted); font-weight:600}

    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
    .kpi .box{border:1px solid var(--line); border-radius:14px; padding:12px; background:#fff}
    .kpi .t{color:var(--muted); font-size:12px}
    .kpi .v{margin-top:6px; font-size:18px; font-weight:780; letter-spacing:.2px}

    canvas{width:100%; height:300px; border-radius:14px; border:1px solid var(--line); background:#fff;}

    .watermark{
      position:fixed; right:10px; bottom:10px;
      font-size:13px;
      color:rgba(11,26,42,.40);
      background:rgba(255,255,255,.75);
      border:1px solid rgba(230,233,242,.9);
      padding:8px 12px;
      border-radius:999px;
      backdrop-filter: blur(6px);
    }
    .inlineWarn{margin-top:10px; font-size:12px; color:var(--danger)}
    .mutedLine{margin-top:6px; font-size:12px; color:var(--muted)}

    .miniBtn{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-size:12px;
    }

    .wAmt{min-width:110px}
    .wProd{min-width:160px}
    .wCcy{min-width:105px}
    .wRate{min-width:90px}
    .wCalc{min-width:220px}
    .wTax{min-width:120px}
    .wBtn{min-width:70px}

    .taxWrap{display:flex; gap:8px; align-items:center;}
    .taxWrap label{display:flex; gap:6px; align-items:center; margin:0; font-size:12px; color:var(--muted); white-space:nowrap;}
    .taxWrap input[type="checkbox"]{width:auto; padding:0; margin:0; transform: translateY(1px);}

    .calcWrap{display:flex; flex-direction:column; gap:8px;}
    .rollWrap{display:flex; gap:8px; align-items:center;}
    .rollWrap label{display:flex; gap:6px; align-items:center; margin:0; font-size:12px; color:var(--muted); white-space:nowrap;}
    .rollWrap input[type="checkbox"]{width:auto; padding:0; margin:0; transform: translateY(1px);}
    .rollWrap input[type="number"]{width:78px; padding:8px 10px; border-radius:10px; font-size:12px;}

    @media (max-width: 860px){
      .kpi{grid-template-columns:1fr;}
      table{min-width:1100px;}
    }
  </style>
</head>

<body>
<header>
  <div class="headTop">
    <div>
      <h1 id="t_title">PB Allocation Engine <span class="pill" id="t_roadshow">Roadshow</span></h1>
      <div class="sub" id="t_sub">
        Spot + Forward (faiz farkı) ile vade sonu kurlar → Giriş para birimine dönüşte Net P/L.
      </div>
    </div>

    <div class="headRight">
      <div class="buildTag" id="buildTag">Build: V13</div>
      <div class="langSel">
        <label id="t_langLabel">Dil</label>
        <select id="lang">
          <option value="tr">Türkçe</option>
          <option value="en">English</option>
        </select>
      </div>
    </div>
  </div>
</header>

<div class="wrap">

  <div class="card">
    <div class="topbar">
      <div class="topcol">
        <h2 id="t_sec1">1) Müşteri Varlığı</h2>

        <label id="t_totalAsset">Toplam Varlık</label>
        <input id="total_amount" type="text" inputmode="decimal" value="1,000,000" />

        <div class="row">
          <div>
            <label id="t_principalCcy">Giriş Para Birimi (Principal)</label>
            <select id="total_ccy">
              <option value="USD" selected>USD</option>
              <option value="TL">TL</option>
              <option value="EUR">EUR</option>
              <option value="XAUg" id="opt_gold_tr">Altın (gram)</option>
            </select>
          </div>
          <div>
            <label id="t_reportCcy">Rapor Para Birimi (Dashboard)</label>
            <select id="report_ccy">
              <option value="TL" selected>TL</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="XAUg" id="opt_gold2_tr">Altın (gram)</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label id="t_tenorType">Global Vade Tipi</label>
            <select id="tenor_type">
              <option value="DAYS" selected id="opt_days_tr">Gün</option>
              <option value="MONTHS" id="opt_months_tr">Ay</option>
            </select>
          </div>
          <div>
            <label id="t_tenor">Global Vade</label>
            <input id="tenor_val" type="number" step="1" value="183" />
          </div>
        </div>

        <div class="small" id="t_tenorNote">
          Vade bir kez seçilir → tüm satırlara otomatik uygulanır.
        </div>
      </div>

      <div class="topcol">
        <h2 id="t_sec2">2) Başlangıç Kurları (Spot)</h2>

        <div class="row3">
          <div>
            <label id="t_goldSpot">Altın (gram/TRY)</label>
            <input id="xautry_g" type="number" step="0.01" value="0" />
          </div>
          <div>
            <label>USD/TRY</label>
            <input id="usdtry" type="number" step="0.0001" value="0" />
          </div>
          <div>
            <label>EUR/TRY</label>
            <input id="eurtry" type="number" step="0.0001" value="0" />
          </div>
        </div>

        <div class="btns">
          <button class="ghost" id="btn_rates">Kurları Çek</button>
          <button class="ghost" id="btn_use_manual">Manuel Kur Kullan</button>
        </div>
        <div id="rate_status" class="mutedLine"></div>

        <div class="small" id="t_rateNote">
          Not: Trunçgil tarayıcıda engellenirse USD/EUR alternatif kaynaktan gelir; altın manuel kalabilir.
        </div>
      </div>

      <div class="topcol">
        <h2 id="t_sec3">3) Vade Sonu Kurları (Oto)</h2>

        <div class="row">
          <div>
            <label id="t_endMode">Vade Sonu Kur Modu</label>
            <select id="end_mode">
              <option value="SPOT" selected id="opt_endSpot_tr">Spot = Vade Sonu</option>
              <option value="FWD" id="opt_endFwd_tr">Forward (Faiz farkı)</option>
              <option value="MANUAL" id="opt_endManual_tr">Manuel</option>
            </select>
          </div>
          <div>
            <label id="t_goldExp">Altın Beklenti (yıllık %)</label>
            <input id="gold_exp" type="number" step="0.01" value="0" />
          </div>
        </div>

        <div class="row3">
          <div>
            <label id="t_goldEnd">Altın (gram/TRY) – Vade Sonu</label>
            <input id="xautry_g_end" type="number" step="0.01" value="" placeholder="oto dolar" />
          </div>
          <div>
            <label id="t_usdEnd">USD/TRY – Vade Sonu</label>
            <input id="usdtry_end" type="number" step="0.0001" value="" placeholder="oto dolar" />
          </div>
          <div>
            <label id="t_eurEnd">EUR/TRY – Vade Sonu</label>
            <input id="eurtry_end" type="number" step="0.0001" value="" placeholder="oto dolar" />
          </div>
        </div>

        <div class="row3">
          <div>
            <label id="t_rtl">TL faiz (yıllık %)</label>
            <input id="rtl" type="number" step="0.01" value="45" />
          </div>
          <div>
            <label id="t_rusd">USD faiz (yıllık %)</label>
            <input id="rusd" type="number" step="0.01" value="5" />
          </div>
          <div>
            <label id="t_reur">EUR faiz (yıllık %)</label>
            <input id="reur" type="number" step="0.01" value="3" />
          </div>
        </div>

        <div class="btns">
          <button class="ghost" id="btn_fill_end" style="flex:1;">Vade Sonu Kurları Doldur</button>
          <button class="primary" id="btn_calc" style="flex:1;">Hesapla</button>
          <button class="danger" id="btn_reset" style="flex:1;">Sıfırla</button>
        </div>

        <div class="small" id="end_note"></div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <h2 id="t_allocTitle">Alokasyon (Tutar Bazlı) <span class="pill" id="pillInfo">hazır</span></h2>

    <div class="kpi" style="grid-template-columns:1fr; margin-top:12px;">
      <div class="box">
        <div class="t" id="t_headline">Headline – Net P/L (Giriş Para Birimi)</div>
        <div class="v" id="headline_pl">-</div>
        <div class="mutedLine" id="headline_detail"></div>
      </div>
    </div>

    <div id="risk_badges" class="small" style="margin-top:8px;"></div>

    <div class="btns scroller" style="margin-top:10px;">
      <button class="ghost" id="btn_add">+ Satır Ekle</button>
      <button class="ghost" id="btn_s1">Dengeli</button>
      <button class="ghost" id="btn_s2">Koruma</button>
      <button class="ghost" id="btn_s3">Büyüme (Riskli)</button>
      <button class="ghost" id="btn_s4">FX Hedge</button>
      <button class="ghost" id="btn_s5">DPM Ağırlıklı</button>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th class="wAmt" id="hdr_amt">Tutar (Giriş PB)</th>
            <th class="wProd" id="th_prod">Ürün</th>
            <th class="wCcy" id="th_target">Hedef PB</th>
            <th class="wRate" id="th_rate">Yıllık %</th>
            <th class="wCalc" id="th_calc">Hesap</th>
            <th class="wTax" id="th_tax">Stopaj</th>
            <th id="th_p">Anapara (Hedef PB)</th>
            <th id="th_fv">Vade Sonu (Hedef PB)</th>
            <th id="th_net">Net Kazanç (Hedef PB)</th>
            <th class="wBtn"></th>
          </tr>
        </thead>
        <tbody id="allocBody"></tbody>
      </table>
    </div>

    <div class="kpi">
      <div class="box">
        <div class="t" id="t_used">Kullanılan Tutar (Giriş PB)</div>
        <div class="v" id="kpi_used">-</div>
      </div>
      <div class="box">
        <div class="t" id="t_left">Kalan Tutar (Giriş PB)</div>
        <div class="v" id="kpi_left">-</div>
      </div>
    </div>

    <div class="kpi">
      <div class="box">
        <div class="t" id="t_portTotal">Portföy Toplamı (Rapor PB)</div>
        <div class="v" id="kpi_total_report">-</div>
      </div>
      <div class="box">
        <div class="t" id="t_portGain">Net Kazanç (Rapor PB)</div>
        <div class="v" id="kpi_gain_report">-</div>
      </div>
    </div>

    <div style="margin-top:12px;">
      <canvas id="chart"></canvas>
      <div class="small" id="t_chartNote">Grafik: Dağılım + Kâr/Zarar – Rapor PB</div>
    </div>

    <div id="warn" class="inlineWarn"></div>
  </div>

</div>

<div class="watermark">Adem Soyer</div>

<script>
/* ========== V13: Stabil event wiring (no inline onclick) ========== */
(() => {
  const BUILD = "V13";

  const $ = (id) => document.getElementById(id);

  // ---------- i18n ----------
  const I18N = {
    tr: {
      langLabel:"Dil",
      roadshow:"Roadshow",
      sub:"Spot + Forward (faiz farkı) ile vade sonu kurlar → Giriş para birimine dönüşte Net P/L.",
      sec1:"1) Müşteri Varlığı",
      totalAsset:"Toplam Varlık",
      principalCcy:"Giriş Para Birimi (Principal)",
      reportCcy:"Rapor Para Birimi (Dashboard)",
      goldGram:"Altın (gram)",
      tenorType:"Global Vade Tipi",
      days:"Gün", months:"Ay",
      tenor:"Global Vade",
      tenorNote:"Vade bir kez seçilir → tüm satırlara otomatik uygulanır.",
      sec2:"2) Başlangıç Kurları (Spot)",
      goldSpot:"Altın (gram/TRY)",
      btnRates:"Kurları Çek",
      btnManual:"Manuel Kur Kullan",
      rateNote:"Not: Trunçgil tarayıcıda engellenirse USD/EUR alternatif kaynaktan gelir; altın manuel kalabilir.",
      sec3:"3) Vade Sonu Kurları (Oto)",
      endMode:"Vade Sonu Kur Modu",
      endSpot:"Spot = Vade Sonu",
      endFwd:"Forward (Faiz farkı)",
      endManual:"Manuel",
      goldExp:"Altın Beklenti (yıllık %)",
      goldEnd:"Altın (gram/TRY) – Vade Sonu",
      usdEnd:"USD/TRY – Vade Sonu",
      eurEnd:"EUR/TRY – Vade Sonu",
      rtl:"TL faiz (yıllık %)",
      rusd:"USD faiz (yıllık %)",
      reur:"EUR faiz (yıllık %)",
      btnFillEnd:"Vade Sonu Kurları Doldur",
      btnCalc:"Hesapla",
      btnReset:"Sıfırla",
      allocTitle:"Alokasyon (Tutar Bazlı)",
      headline:"Headline – Net P/L (Giriş Para Birimi)",
      btnAddRow:"+ Satır Ekle",
      s1:"Dengeli", s2:"Koruma", s3:"Büyüme (Riskli)", s4:"FX Hedge", s5:"DPM Ağırlıklı",
      th_prod:"Ürün", th_target:"Hedef PB", th_rate:"Yıllık %", th_calc:"Hesap", th_tax:"Stopaj",
      th_p:"Anapara (Hedef PB)", th_fv:"Vade Sonu (Hedef PB)", th_net:"Net Kazanç (Hedef PB)",
      used:"Kullanılan Tutar (Giriş PB)",
      left:"Kalan Tutar (Giriş PB)",
      portTotal:"Portföy Toplamı (Rapor PB)",
      portGain:"Net Kazanç (Rapor PB)",
      chartNote:"Grafik: Dağılım + Kâr/Zarar – Rapor PB",
      prod_term:"Vadeli Mevduat", prod_fund:"Yatırım Fonu", prod_sukuk:"Sukuk", prod_dpm:"DPM",
      calc_simple:"Basit (bankacılık)", calc_comp:"Günlük (bileşik) [opsiyon]",
      rollover:"Yenilemeli", delete:"Sil",
      endNoteSpot:"Spot = Vade Sonu: End kurlar spot ile aynı kabul edilir.",
      endNoteNeedSpot:"Not: Forward/Spot için önce USD/TRY ve EUR/TRY girilmeli ya da çekilmeli.",
      endNoteManual:"Manuel mod: vade sonu kurları sen girersin.",
      endNoteFwd:"Forward modu: USD/TRY & EUR/TRY faiz farkı ile türetildi (proxy). Altın: beklenti % ile.",
      warnTotal0:"Toplam varlık 0 olamaz.",
      warnNeedRow:"En az 1 satır ekle.",
      warnTenor0:"Global vade 0 olamaz.",
      warnMissingSpot:"Başlangıç kurları eksik. (USD/TRY, EUR/TRY, Altın/TRY kontrol et.)",
      warnMissingSpotReport:"Başlangıç kurları eksik (rapor dönüşümü).",
      warnMissingEnd:"Vade sonu kurları eksik. (Mode/Gold/Spot kontrol et.)",
      warnMissingEndReport:"Vade sonu kurları eksik (rapor dönüşümü).",
      warnOverAlloc:"Alokasyon toplamı, toplam varlığı aşıyor. Satır tutarlarını düşür.",
      rateStatusFetching:"Kurlar çekiliyor…",
      rateStatusOkAll:"Trunçgil: USD/EUR/Altın güncellendi.",
      rateStatusOkFxOnly:"USD/EUR alternatif kaynaktan güncellendi. Altın manuel.",
      rateStatusFail:"Kurlar çekilemedi. Manuel girip devam edebilirsin.",
      rateStatusManualOk:"Manuel kur kullanılıyor.",
      rateStatusManualBad:"Manuel kur eksik.",
      riskLine:"Risk/Dağılım (ürün bazlı, başlangıç kurlarıyla):",
      donutAllocTitle:"Dağılım (Başlangıç - Rapor PB)",
      donutPLTitle:"Kâr/Zarar (Vade Sonu - Rapor PB)",
      donutMidTitle:"Toplam Net P/L (Rapor PB)"
    },
    en: {
      langLabel:"Language",
      roadshow:"Roadshow",
      sub:"Spot + Forward (interest differential) end-rates → Net P/L back in the principal currency.",
      sec1:"1) Client Asset",
      totalAsset:"Total Asset",
      principalCcy:"Principal Currency",
      reportCcy:"Reporting Currency (Dashboard)",
      goldGram:"Gold (gram)",
      tenorType:"Global Tenor Type",
      days:"Days", months:"Months",
      tenor:"Global Tenor",
      tenorNote:"Choose tenor once → applied to all rows.",
      sec2:"2) Spot Rates",
      goldSpot:"Gold (gram/TRY)",
      btnRates:"Fetch Rates",
      btnManual:"Use Manual Rates",
      rateNote:"Note: If Trunçgil is blocked, USD/EUR may come from fallback; gold can remain manual.",
      sec3:"3) End Rates (Auto)",
      endMode:"End Rate Mode",
      endSpot:"Spot = End",
      endFwd:"Forward (IR diff)",
      endManual:"Manual",
      goldExp:"Gold Expectation (annual %)",
      goldEnd:"Gold (gram/TRY) – End",
      usdEnd:"USD/TRY – End",
      eurEnd:"EUR/TRY – End",
      rtl:"TRY rate (annual %)",
      rusd:"USD rate (annual %)",
      reur:"EUR rate (annual %)",
      btnFillEnd:"Fill End Rates",
      btnCalc:"Calculate",
      btnReset:"Reset",
      allocTitle:"Allocation (Amount-based)",
      headline:"Headline – Net P/L (Principal Currency)",
      btnAddRow:"+ Add Row",
      s1:"Balanced", s2:"Conservative", s3:"Growth (Risky)", s4:"FX Hedge", s5:"DPM Focus",
      th_prod:"Product", th_target:"Target CCY", th_rate:"Annual %", th_calc:"Method", th_tax:"Withholding",
      th_p:"Principal (Target)", th_fv:"End Value (Target)", th_net:"Net Gain (Target)",
      used:"Used (Principal)",
      left:"Remaining (Principal)",
      portTotal:"Portfolio Total (Report CCY)",
      portGain:"Net Gain (Report CCY)",
      chartNote:"Chart: Allocation + P/L breakdown – Report CCY",
      prod_term:"Time Deposit", prod_fund:"Investment Fund", prod_sukuk:"Sukuk", prod_dpm:"DPM",
      calc_simple:"Simple (bank-style)", calc_comp:"Daily comp (optional)",
      rollover:"Rollover", delete:"Delete",
      endNoteSpot:"Spot = End: end rates assumed equal to spot.",
      endNoteNeedSpot:"Note: For Spot/Forward, please enter or fetch USD/TRY and EUR/TRY first.",
      endNoteManual:"Manual mode: you enter the end rates.",
      endNoteFwd:"Forward mode: USD/TRY & EUR/TRY derived from IR differential (proxy). Gold uses expectation %.",
      warnTotal0:"Total asset cannot be 0.",
      warnNeedRow:"Please add at least 1 row.",
      warnTenor0:"Global tenor cannot be 0.",
      warnMissingSpot:"Missing spot rates. (Check USD/TRY, EUR/TRY, Gold/TRY.)",
      warnMissingSpotReport:"Missing spot rates (report conversion).",
      warnMissingEnd:"Missing end rates. (Check Mode/Gold/Spot.)",
      warnMissingEndReport:"Missing end rates (report conversion).",
      warnOverAlloc:"Allocation exceeds total asset. Reduce row amounts.",
      rateStatusFetching:"Fetching rates…",
      rateStatusOkAll:"Trunçgil: USD/EUR/Gold updated.",
      rateStatusOkFxOnly:"USD/EUR updated from fallback. Gold manual.",
      rateStatusFail:"Could not fetch rates. You can proceed with manual input.",
      rateStatusManualOk:"Using manual rates.",
      rateStatusManualBad:"Manual rates missing.",
      riskLine:"Risk/Allocation (by product, start rates):",
      donutAllocTitle:"Allocation (Start - Report CCY)",
      donutPLTitle:"P/L Breakdown (End - Report CCY)",
      donutMidTitle:"Total Net P/L (Report CCY)"
    }
  };

  function getLang(){
    const saved = localStorage.getItem("pb_lang");
    return (saved === "en" || saved === "tr") ? saved : "tr";
  }
  function t(key){
    const lang = $("lang").value;
    return (I18N[lang] && I18N[lang][key]) ? I18N[lang][key] : (I18N.tr[key] || key);
  }

  function applyLang(){
    const lang = $("lang").value;
    document.documentElement.lang = lang;

    $("buildTag").textContent = "Build: " + BUILD;
    $("t_roadshow").textContent = t("roadshow");
    $("t_sub").textContent = t("sub");
    $("t_langLabel").textContent = t("langLabel");

    $("t_sec1").textContent = t("sec1");
    $("t_totalAsset").textContent = t("totalAsset");
    $("t_principalCcy").textContent = t("principalCcy");
    $("t_reportCcy").textContent = t("reportCcy");
    $("opt_gold_tr").textContent = t("goldGram");
    $("opt_gold2_tr").textContent = t("goldGram");
    $("t_tenorType").textContent = t("tenorType");
    $("opt_days_tr").textContent = t("days");
    $("opt_months_tr").textContent = t("months");
    $("t_tenor").textContent = t("tenor");
    $("t_tenorNote").textContent = t("tenorNote");

    $("t_sec2").textContent = t("sec2");
    $("t_goldSpot").textContent = t("goldSpot");
    $("btn_rates").textContent = t("btnRates");
    $("btn_use_manual").textContent = t("btnManual");
    $("t_rateNote").textContent = t("rateNote");

    $("t_sec3").textContent = t("sec3");
    $("t_endMode").textContent = t("endMode");
    $("opt_endSpot_tr").textContent = t("endSpot");
    $("opt_endFwd_tr").textContent = t("endFwd");
    $("opt_endManual_tr").textContent = t("endManual");
    $("t_goldExp").textContent = t("goldExp");
    $("t_goldEnd").textContent = t("goldEnd");
    $("t_usdEnd").textContent = t("usdEnd");
    $("t_eurEnd").textContent = t("eurEnd");
    $("t_rtl").textContent = t("rtl");
    $("t_rusd").textContent = t("rusd");
    $("t_reur").textContent = t("reur");
    $("btn_fill_end").textContent = t("btnFillEnd");
    $("btn_calc").textContent = t("btnCalc");
    $("btn_reset").textContent = t("btnReset");

    // allocation
    $("t_allocTitle").childNodes[0].nodeValue = t("allocTitle") + " ";
    $("t_headline").textContent = t("headline");
    $("btn_add").textContent = t("btnAddRow");
    $("btn_s1").textContent = t("s1");
    $("btn_s2").textContent = t("s2");
    $("btn_s3").textContent = t("s3");
    $("btn_s4").textContent = t("s4");
    $("btn_s5").textContent = t("s5");

    $("th_prod").textContent = t("th_prod");
    $("th_target").textContent = t("th_target");
    $("th_rate").textContent = t("th_rate");
    $("th_calc").textContent = t("th_calc");
    $("th_tax").textContent = t("th_tax");
    $("th_p").textContent = t("th_p");
    $("th_fv").textContent = t("th_fv");
    $("th_net").textContent = t("th_net");

    $("t_used").textContent = t("used");
    $("t_left").textContent = t("left");
    $("t_portTotal").textContent = t("portTotal");
    $("t_portGain").textContent = t("portGain");
    $("t_chartNote").textContent = t("chartNote");

    $("xautry_g_end").placeholder = (lang==="en") ? "auto fill" : "oto dolar";
    $("usdtry_end").placeholder = (lang==="en") ? "auto fill" : "oto dolar";
    $("eurtry_end").placeholder = (lang==="en") ? "auto fill" : "oto dolar";

    refreshRowsI18n();
    setAmtHeader();
    if(!$("end_note").textContent) $("end_note").textContent = t("endNoteSpot");
  }

  function refreshRowsI18n(){
    const rows = Array.from(document.querySelectorAll("#allocBody tr"));
    for(const tr of rows){
      const id = tr.dataset.id;
      const prodSel = $("prod_"+id);
      if(prodSel){
        for(const opt of prodSel.options){
          if(opt.value==="TERM") opt.textContent = t("prod_term");
          if(opt.value==="FUND") opt.textContent = t("prod_fund");
          if(opt.value==="SUKUK") opt.textContent = t("prod_sukuk");
          if(opt.value==="DPM")  opt.textContent = t("prod_dpm");
        }
      }
      const mSel = $("method_"+id);
      if(mSel){
        for(const opt of mSel.options){
          if(opt.value==="SIMPLE") opt.textContent = t("calc_simple");
          if(opt.value==="DAILY_COMPOUND") opt.textContent = t("calc_comp");
        }
      }
      const rollText = tr.querySelector('[data-role="rollText"]');
      if(rollText) rollText.textContent = t("rollover");
      const delBtn = tr.querySelector('[data-action="delete-row"]');
      if(delBtn) delBtn.textContent = t("delete");

      const ccySel = $("ccy_"+id);
      if(ccySel){
        for(const opt of ccySel.options){
          if(opt.value==="XAUg") opt.textContent = ($("lang").value==="en") ? "Gold" : "Altın";
        }
      }
    }
  }

  // ---------- helpers ----------
  function parseAmount(str){
    if(!str) return 0;
    let s = String(str).trim().replace(/\s/g,'');
    if(s.includes(',') && s.includes('.')) s = s.replace(/[.,]/g,'');
    else s = s.replace(/,/g,'').replace(/\./g,'');
    const n = Number(s);
    return isFinite(n) ? n : 0;
  }
  function fmtMoney(n, ccy){
    const abs = Math.abs(n);
    const opts = abs >= 100000 ? { maximumFractionDigits: 0 } : { maximumFractionDigits: 2 };
    return new Intl.NumberFormat('tr-TR', opts).format(n) + ' ' + ccy;
  }
  function clamp(x){ return Math.max(0, Number(x)||0); }
  function round2(x){ return Math.round((Number(x)||0) * 100) / 100; }

  function setAmtHeader(){
    const ccy = $("total_ccy").value;
    const lang = $("lang").value;
    $("hdr_amt").textContent = (lang==="en")
      ? ("Amount (Principal – " + ccy + ")")
      : ("Tutar (Giriş PB – " + ccy + ")");
  }

  // ---------- tenor ----------
  function globalDays(){
    const ttype = $("tenor_type").value;
    const v = Number($("tenor_val").value)||0;
    const n = clamp(v);
    if(ttype === "DAYS") return n;

    if(n===1) return 31;
    if(n===3) return 92;
    if(n===6) return 183;
    if(n===12) return 365;
    return n * 30.4375;
  }

  // ---------- rates ----------
  function getStartRates(){
    return {
      usdtry: Number($("usdtry").value)||0,
      eurtry: Number($("eurtry").value)||0,
      xautry_g: Number($("xautry_g").value)||0
    };
  }
  function setEndRates(o){
    if(o.xautry_g != null && isFinite(o.xautry_g)) $("xautry_g_end").value = Number(o.xautry_g).toFixed(2);
    if(o.usdtry != null && isFinite(o.usdtry)) $("usdtry_end").value = Number(o.usdtry).toFixed(4);
    if(o.eurtry != null && isFinite(o.eurtry)) $("eurtry_end").value = Number(o.eurtry).toFixed(4);
  }
  function getEndRatesResolved(){
    const s = getStartRates();
    const usdtry_end = Number($("usdtry_end").value)||0;
    const eurtry_end = Number($("eurtry_end").value)||0;
    const xautry_g_end = Number($("xautry_g_end").value)||0;
    return {
      usdtry: usdtry_end>0 ? usdtry_end : s.usdtry,
      eurtry: eurtry_end>0 ? eurtry_end : s.eurtry,
      xautry_g: xautry_g_end>0 ? xautry_g_end : s.xautry_g
    };
  }

  function fxRate(from, to, when){
    if(from === to) return 1;
    const r = (when === "end") ? getEndRatesResolved() : getStartRates();
    const usdtry = r.usdtry, eurtry = r.eurtry, xautry_g = r.xautry_g;

    const toTRY = (ccy)=>{
      if(ccy==="TL") return 1;
      if(ccy==="USD") return usdtry>0 ? usdtry : null;
      if(ccy==="EUR") return eurtry>0 ? eurtry : null;
      if(ccy==="XAUg") return xautry_g>0 ? xautry_g : null;
      return null;
    };
    const fromTRY = (ccy)=>{
      if(ccy==="TL") return 1;
      if(ccy==="USD") return usdtry>0 ? (1/usdtry) : null;
      if(ccy==="EUR") return eurtry>0 ? (1/eurtry) : null;
      if(ccy==="XAUg") return xautry_g>0 ? (1/xautry_g) : null;
      return null;
    };

    const a = toTRY(from);
    const b = fromTRY(to);
    if(a==null || b==null) return null;
    return a*b;
  }

  async function fetchRatesAll(){
    $("rate_status").textContent = t("rateStatusFetching");

    try{
      const res = await fetch("https://finans.truncgil.com/v4/today.json", { cache:"no-store" });
      if(res.ok){
        const data = await res.json();
        const usd = data?.USD?.Selling ?? data?.USD?.Buying;
        const eur = data?.EUR?.Selling ?? data?.EUR?.Buying;
        const gra = data?.GRA?.Selling ?? data?.GRA?.Buying;
        if(usd && eur){
          $("usdtry").value = Number(usd).toFixed(4);
          $("eurtry").value = Number(eur).toFixed(4);
          if(gra) $("xautry_g").value = Number(gra).toFixed(2);
          $("rate_status").textContent = t("rateStatusOkAll");
          autoFillEndRates();
          return;
        }
      }
    }catch(e){}

    try{
      const r = await fetch("https://open.er-api.com/v6/latest/TRY", { cache:"no-store" });
      if(!r.ok) throw new Error("fallback failed");
      const j = await r.json();
      const usd = j?.rates?.USD;
      const eur = j?.rates?.EUR;
      if(usd && eur){
        $("usdtry").value = (1/Number(usd)).toFixed(4);
        $("eurtry").value = (1/Number(eur)).toFixed(4);
        $("rate_status").textContent = t("rateStatusOkFxOnly");
        autoFillEndRates();
        return;
      }
      throw new Error("rates missing");
    }catch(e2){
      $("rate_status").textContent = t("rateStatusFail");
    }
  }

  function autoFillEndRates(){
    const mode = $("end_mode").value;
    const note = $("end_note");
    const s = getStartRates();
    const days = globalDays();
    const T = days/365;

    if(mode !== "MANUAL"){
      if(s.usdtry<=0 || s.eurtry<=0){
        note.textContent = t("endNoteNeedSpot");
        return;
      }
    }

    if(mode === "MANUAL"){
      note.textContent = t("endNoteManual");
      return;
    }

    if(mode === "SPOT"){
      setEndRates({ usdtry:s.usdtry, eurtry:s.eurtry, xautry_g: (s.xautry_g>0 ? s.xautry_g : null) });
      note.textContent = t("endNoteSpot");
      return;
    }

    const rTL  = (Number($("rtl").value)||0)/100;
    const rUSD = (Number($("rusd").value)||0)/100;
    const rEUR = (Number($("reur").value)||0)/100;

    const usdEnd = s.usdtry * ((1 + rTL*T) / (1 + rUSD*T));
    const eurEnd = s.eurtry * ((1 + rTL*T) / (1 + rEUR*T));

    const gExp = (Number($("gold_exp").value)||0)/100;
    const goldEnd = (s.xautry_g>0) ? (s.xautry_g * (1 + gExp*T)) : null;

    setEndRates({ usdtry:usdEnd, eurtry:eurEnd, xautry_g:goldEnd });
    note.textContent = t("endNoteFwd");
  }

  // ---------- product math ----------
  function bankStyleSimple(P, annualPct, days, taxPct){
    const r = (Number(annualPct)||0)/100;
    const gross = round2(P * r * (days/365));
    const tax = round2(gross * (Number(taxPct||0)/100));
    const net = round2(gross - tax);
    const FV = round2(P + net);
    return { FV, netGain: net };
  }

  function bankStyleRollover(P0, annualPct, totalDays, rollDays, taxPct){
    const r = (Number(annualPct)||0)/100;
    const k = Math.max(1, Math.floor(Number(rollDays)||1));
    let P = round2(P0);

    let remaining = totalDays;
    while(remaining > 0){
      const d = Math.min(k, remaining);
      const gross = round2(P * r * (d/365));
      const tax   = round2(gross * (Number(taxPct||0)/100));
      const net   = round2(gross - tax);
      P = round2(P + net);
      remaining -= d;
    }
    return { FV: P, netGain: round2(P - round2(P0)) };
  }

  function suggestTaxPct(prod, targetCcy, days){
    if(prod === "TERM"){
      if(targetCcy !== "TL") return 25;
      if(days <= 183) return 17.5;
      if(days <= 365) return 15;
      return 10;
    }
    return 0;
  }

  // ---------- HiDPI donuts ----------
  function setupHiDPI(canvas){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const cssW = canvas.clientWidth || 1200;
    const cssH = 300;
    canvas.style.height = cssH + "px";
    canvas.width = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);
    const ctx = canvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return ctx;
  }
  function roundRectPath(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    if(typeof ctx.roundRect === "function"){
      ctx.beginPath(); ctx.roundRect(x,y,w,h,rr); return;
    }
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }
  function donut(ctx, cx, cy, rOuter, rInner, segments, title){
    ctx.save();
    ctx.fillStyle = "#ffffff";
    ctx.strokeStyle = "#e6e9f2";
    ctx.lineWidth = 1;
    roundRectPath(ctx, cx - rOuter - 16, cy - rOuter - 22, (rOuter*2)+32, (rOuter*2)+44, 14);
    ctx.fill(); ctx.stroke();

    ctx.fillStyle = "#5b6777";
    ctx.font = "12px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial";
    ctx.textAlign = "left";
    ctx.fillText(title, cx - rOuter, cy - rOuter - 6);

    const total = segments.reduce((a,s)=>a + Math.max(0, s.value), 0);
    const ringW = rOuter - rInner;

    if(total <= 0){
      ctx.strokeStyle = "rgba(230,233,242,.95)";
      ctx.lineWidth = ringW;
      ctx.beginPath();
      ctx.arc(cx, cy, (rOuter+rInner)/2, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
      return;
    }

    let ang = -Math.PI/2;
    segments.forEach((s)=>{
      const v = Math.max(0, s.value);
      if(v <= 0) return;
      const frac = v / total;
      const a2 = ang + frac * Math.PI*2;
      ctx.strokeStyle = s.color || "rgba(18,58,99,.85)";
      ctx.lineWidth = ringW;
      ctx.lineCap = "butt";
      ctx.beginPath();
      ctx.arc(cx, cy, (rOuter+rInner)/2, ang, a2);
      ctx.stroke();
      ang = a2;
    });

    // legend
    ctx.textAlign = "left";
    ctx.font = "12px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial";
    const legendX = cx + rOuter + 18;
    let legendY = cy - rOuter + 8;
    const maxItems = 6;

    segments
      .filter(s=>Math.max(0,s.value)>0)
      .sort((a,b)=>b.value-a.value)
      .slice(0, maxItems)
      .forEach((s)=>{
        const v = Math.max(0,s.value);
        const pct = (v/total*100);
        ctx.fillStyle = s.color || "rgba(18,58,99,.85)";
        ctx.fillRect(legendX, legendY-9, 10, 10);
        ctx.fillStyle = "#0b1a2a";
        ctx.fillText(`${s.label}  ${pct.toFixed(1)}%`, legendX + 14, legendY);
        legendY += 18;
      });

    ctx.restore();
  }
  function drawDualDonutChart(canvas, allocSegments, plSegments, totalPLText){
    const ctx = setupHiDPI(canvas);
    const W = canvas.clientWidth || 1200;
    const H = 300;
    ctx.clearRect(0,0,W,H);

    const leftCX  = Math.round(W * 0.28);
    const rightCX = Math.round(W * 0.72);
    const cy = Math.round(H * 0.52);

    const rOuter = 86, rInner = 56;

    donut(ctx, leftCX,  cy, rOuter, rInner, allocSegments, t("donutAllocTitle"));
    donut(ctx, rightCX, cy, rOuter, rInner, plSegments,    t("donutPLTitle"));

    ctx.save();
    ctx.fillStyle = "#5b6777";
    ctx.font = "12px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial";
    ctx.textAlign = "center";
    ctx.fillText(t("donutMidTitle"), Math.round(W/2), 122);

    ctx.fillStyle = "#0b1a2a";
    ctx.font = "18px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial";
    ctx.fillText(totalPLText || "-", Math.round(W/2), 150);

    ctx.fillStyle = "rgba(200,163,58,.95)";
    ctx.fillRect(Math.round(W/2)-60, 158, 120, 3);
    ctx.restore();
  }

  // ---------- rows ----------
  const PRODUCT_VALUES = ["TERM","FUND","SUKUK","DPM"];

  function rowHTML(id){
    const goldLabel = ($("lang").value==="en") ? "Gold" : "Altın";

    const prodOptions = PRODUCT_VALUES.map(v=>{
      const label =
        (v==="TERM") ? t("prod_term") :
        (v==="FUND") ? t("prod_fund") :
        (v==="SUKUK") ? t("prod_sukuk") :
        t("prod_dpm");
      return `<option value="${v}">${label}</option>`;
    }).join("");

    const html = `
      <tr data-id="${id}">
        <td class="wAmt"><input type="number" step="0.01" id="amt_${id}" value="0"></td>
        <td class="wProd">
          <select id="prod_${id}">${prodOptions}</select>
        </td>
        <td class="wCcy">
          <select id="ccy_${id}">
            <option value="TL">TL</option>
            <option value="USD" selected>USD</option>
            <option value="EUR">EUR</option>
            <option value="XAUg">${goldLabel}</option>
          </select>
        </td>
        <td class="wRate"><input type="number" step="0.01" id="rate_${id}" value="0"></td>
        <td class="wCalc">
          <div class="calcWrap">
            <select id="method_${id}">
              <option value="SIMPLE" selected>${t("calc_simple")}</option>
              <option value="DAILY_COMPOUND">${t("calc_comp")}</option>
            </select>
            <div class="rollWrap" id="rollWrap_${id}" style="display:none;">
              <label>
                <input type="checkbox" id="roll_${id}">
                <span data-role="rollText">${t("rollover")}</span>
              </label>
              <input type="number" min="1" step="1" id="rollDays_${id}" value="2">
            </div>
          </div>
        </td>
        <td class="wTax">
          <div class="taxWrap">
            <input type="number" step="0.01" id="tax_${id}" value="0" style="flex:1;">
            <label><input type="checkbox" id="taxAuto_${id}" checked>Auto</label>
          </div>
        </td>
        <td id="p_${id}">-</td>
        <td id="fv_${id}">-</td>
        <td id="net_${id}">-</td>
        <td class="wBtn">
          <button class="miniBtn" data-action="delete-row" data-id="${id}">${t("delete")}</button>
        </td>
      </tr>
    `;
    return html;
  }

  function addRow(preset={}){
    const id = String(Math.random()).slice(2,8);
    $("allocBody").insertAdjacentHTML("beforeend", rowHTML(id));

    if(preset.amt != null) $("amt_"+id).value = preset.amt;
    if(preset.ccy) $("ccy_"+id).value = preset.ccy;
    if(preset.prod) $("prod_"+id).value = preset.prod;
    if(preset.rate != null) $("rate_"+id).value = preset.rate;
    if(preset.method) $("method_"+id).value = preset.method;
    if(preset.tax != null) $("tax_"+id).value = preset.tax;
    if(preset.taxAuto != null) $("taxAuto_"+id).checked = preset.taxAuto;

    if(preset.roll != null) $("roll_"+id).checked = preset.roll;
    if(preset.rollDays != null) $("rollDays_"+id).value = preset.rollDays;

    applyDefaultsByProduct(id);
    toggleRolloverUI(id);
    refreshRowsI18n();
  }

  function removeRow(id){
    const tr = document.querySelector(`#allocBody tr[data-id="${id}"]`);
    if(tr) tr.remove();
  }

  function applyDefaultsByProduct(id){
    const prod = $("prod_"+id).value;
    const rateEl = $("rate_"+id);
    const methodEl = $("method_"+id);
    const r = Number(rateEl.value)||0;

    if(prod==="TERM"){
      if(r===0) rateEl.value = 35;
      methodEl.value = "SIMPLE";
    } else if(prod==="FUND"){
      if(r===0) rateEl.value = 42;
      methodEl.value = "SIMPLE";
    } else if(prod==="SUKUK"){
      if(r===0) rateEl.value = 38;
      methodEl.value = "SIMPLE";
    } else if(prod==="DPM"){
      if(r===0) rateEl.value = 18;
      methodEl.value = "SIMPLE";
    }
  }

  function toggleRolloverUI(id){
    const prod = $("prod_"+id).value;
    const wrap = $("rollWrap_"+id);
    if(!wrap) return;
    if(prod === "TERM"){
      wrap.style.display = "flex";
    } else {
      wrap.style.display = "none";
      const chk = $("roll_"+id);
      if(chk) chk.checked = false;
    }
  }

  // ---------- calc ----------
  function calc(){
    $("warn").textContent = "";
    autoFillEndRates();

    const principalAmt = parseAmount($("total_amount").value);
    const principalCcy = $("total_ccy").value;
    const reportCcy = $("report_ccy").value;

    if(principalAmt <= 0){ $("warn").textContent = t("warnTotal0"); return; }

    const rows = Array.from(document.querySelectorAll("#allocBody tr"));
    if(rows.length === 0){ $("warn").textContent = t("warnNeedRow"); return; }

    const days = globalDays();
    if(days <= 0){ $("warn").textContent = t("warnTenor0"); return; }

    let usedPrincipal = 0;
    let totalFV_report = 0;
    let totalNetGain_report = 0;
    let totalEnd_principalCcy = 0;

    const byProductReport = { TERM:0, FUND:0, SUKUK:0, DPM:0 };
    let totalPrincipalReport = 0;

    const rowLabels = [];
    const rowPL_report = [];

    for(const tr of rows){
      const id = tr.dataset.id;

      const amtBase = clamp($("amt_"+id).value);
      const prod = $("prod_"+id).value;
      const targetCcy = $("ccy_"+id).value;
      const rate = Number($("rate_"+id).value)||0;
      const method = $("method_"+id).value;

      const taxAuto = $("taxAuto_"+id).checked;
      let taxPct = Number($("tax_"+id).value)||0;
      if(taxAuto){
        taxPct = suggestTaxPct(prod, targetCcy, days);
        $("tax_"+id).value = taxPct;
      }

      usedPrincipal += amtBase;

      const r1 = fxRate(principalCcy, targetCcy, "start");
      if(r1 === null){ $("warn").textContent = t("warnMissingSpot"); return; }
      const P_target = amtBase * r1;

      const rP_start = fxRate(targetCcy, reportCcy, "start");
      if(rP_start === null){ $("warn").textContent = t("warnMissingSpotReport"); return; }
      const P_report_start = P_target * rP_start;

      totalPrincipalReport += P_report_start;
      byProductReport[prod] = (byProductReport[prod]||0) + P_report_start;

      let FV_target_net, netGain_target;

      const rollOn = !!$("roll_"+id)?.checked;
      const rollDays = Number($("rollDays_"+id)?.value)||2;

      if(prod==="TERM" && rollOn){
        const out = bankStyleRollover(P_target, rate, days, rollDays, taxPct);
        FV_target_net = out.FV;
        netGain_target = out.netGain;
      } else if(method==="DAILY_COMPOUND"){
        const r = (Number(rate)||0)/100;
        const FV_gross = P_target * Math.pow(1 + r/365, days);
        const grossGain = FV_gross - P_target;
        const tax = grossGain * (taxPct/100);
        netGain_target = grossGain - tax;
        FV_target_net = P_target + netGain_target;
      } else {
        const out = bankStyleSimple(P_target, rate, days, taxPct);
        FV_target_net = out.FV;
        netGain_target = out.netGain;
      }

      const rBack_end = fxRate(targetCcy, principalCcy, "end");
      if(rBack_end === null){ $("warn").textContent = t("warnMissingEnd"); return; }
      const end_in_principal = FV_target_net * rBack_end;
      totalEnd_principalCcy += end_in_principal;

      const rToReport_end = fxRate(targetCcy, reportCcy, "end");
      if(rToReport_end === null){ $("warn").textContent = t("warnMissingEndReport"); return; }
      const FV_report_end = FV_target_net * rToReport_end;
      const netGain_report_end = netGain_target * rToReport_end;

      totalFV_report += FV_report_end;
      totalNetGain_report += netGain_report_end;

      $("p_"+id).textContent  = fmtMoney(P_target, targetCcy);
      $("fv_"+id).textContent = fmtMoney(FV_target_net, targetCcy);
      $("net_"+id).textContent= fmtMoney(netGain_target, targetCcy);

      const short =
        (prod==="TERM") ? (t("prod_term")==="Time Deposit" ? "TD" : "Vadeli") :
        (prod==="FUND") ? (t("prod_fund")==="Investment Fund" ? "Fund" : "Fon") :
        (prod==="SUKUK") ? "Sukuk" : "DPM";

      rowLabels.push(short + "-" + targetCcy);
      rowPL_report.push(netGain_report_end);
    }

    $("kpi_used").textContent = fmtMoney(usedPrincipal, principalCcy);
    $("kpi_left").textContent = fmtMoney(principalAmt - usedPrincipal, principalCcy);

    if(usedPrincipal > principalAmt + 1e-9){
      $("warn").textContent = t("warnOverAlloc");
    }

    $("kpi_total_report").textContent = fmtMoney(totalFV_report, reportCcy);
    $("kpi_gain_report").textContent  = fmtMoney(totalNetGain_report, reportCcy);

    const plPrincipal = totalEnd_principalCcy - principalAmt;
    $("headline_pl").textContent = fmtMoney(plPrincipal, principalCcy);

    const detail = ($("lang").value==="en")
      ? (`Start: ${fmtMoney(principalAmt, principalCcy)} → End: ${fmtMoney(totalEnd_principalCcy, principalCcy)} (Tenor: ${days.toFixed(0)} days)`)
      : (`Başlangıç: ${fmtMoney(principalAmt, principalCcy)} → Vade Sonu: ${fmtMoney(totalEnd_principalCcy, principalCcy)} (Global vade: ${days.toFixed(0)} gün)`);

    $("headline_detail").textContent = detail;
    $("pillInfo").textContent = "Principal: " + principalCcy + " | Report: " + reportCcy;

    // Risk badges
    const nameMap = { TERM:t("prod_term"), FUND:t("prod_fund"), SUKUK:t("prod_sukuk"), DPM:t("prod_dpm") };
    if(totalPrincipalReport > 0){
      const items = Object.keys(byProductReport)
        .map(k => ({k, v:byProductReport[k]}))
        .filter(x => x.v > 0)
        .sort((a,b)=>b.v-a.v)
        .map(x => `<span class="pill">${nameMap[x.k]}: ${(x.v/totalPrincipalReport*100).toFixed(1)}%</span>`)
        .join(" ");
      $("risk_badges").innerHTML = `<div class="mutedLine">${t("riskLine")}</div> ${items}`;
    } else {
      $("risk_badges").textContent = "";
    }

    // Donuts
    const allocSegments = Object.keys(byProductReport)
      .map((k, idx) => ({
        label: nameMap[k],
        value: byProductReport[k] || 0,
        color: ["rgba(18,58,99,.92)","rgba(200,163,58,.92)","rgba(18,58,99,.65)","rgba(200,163,58,.65)"][idx % 4]
      }))
      .filter(x => x.value > 0);

    const plSegments = [];
    for(let i=0;i<rowLabels.length;i++){
      const v = Number(rowPL_report[i]) || 0;
      if(v === 0) continue;
      plSegments.push({
        label: rowLabels[i],
        value: Math.abs(v),
        color: (v >= 0) ? null : "rgba(155,28,28,.78)"
      });
    }
    const blues = ["rgba(18,58,99,.92)","rgba(18,58,99,.70)","rgba(18,58,99,.50)"];
    let posIdx = 0;
    plSegments.forEach(s=>{
      if(s.color) return;
      s.color = blues[posIdx % blues.length];
      posIdx++;
    });

    drawDualDonutChart($("chart"), allocSegments, plSegments, fmtMoney(totalNetGain_report, reportCcy));
  }

  // ---------- scenarios ----------
  function applyScenario(weights){
    const totalAmount = parseAmount($("total_amount").value);
    const totalCcy = $("total_ccy").value;
    $("allocBody").innerHTML = "";

    const sum = weights.reduce((a,x)=>a+(x.w||0), 0) || 1;
    const norm = weights.map(x => ({...x, w:(x.w||0)/sum}));

    let allocated = 0;
    for(let i=0;i<norm.length;i++){
      const it = norm[i];
      let amt = (i===norm.length-1) ? (totalAmount-allocated) : (totalAmount*it.w);
      amt = Math.max(0, amt);
      allocated += amt;

      addRow({
        amt: Number(amt.toFixed(2)),
        ccy: it.ccy,
        prod: it.prod,
        rate: it.rate,
        method: it.method,
        taxAuto: (it.taxAuto!=null) ? it.taxAuto : true,
        tax: (it.tax!=null) ? it.tax : 0,
        roll: it.roll || false,
        rollDays: it.rollDays || 2
      });
    }

    $("kpi_used").textContent = fmtMoney(totalAmount, totalCcy);
    $("kpi_left").textContent = fmtMoney(0, totalCcy);
    refreshRowsI18n();
  }

  function scenario1(){ applyScenario([
    { w:0.25, ccy:"TL",  prod:"TERM",  rate:35, method:"SIMPLE", taxAuto:true  },
    { w:0.25, ccy:"TL",  prod:"FUND",  rate:42, method:"SIMPLE", taxAuto:false, tax:0 },
    { w:0.25, ccy:"TL",  prod:"SUKUK", rate:38, method:"SIMPLE", taxAuto:false, tax:0 },
    { w:0.25, ccy:"USD", prod:"DPM",   rate:10, method:"SIMPLE", taxAuto:false, tax:0 }
  ]);}

  function scenario2(){ applyScenario([
    { w:0.40, ccy:"TL",  prod:"TERM",  rate:35, method:"SIMPLE", taxAuto:true  },
    { w:0.30, ccy:"TL",  prod:"SUKUK", rate:38, method:"SIMPLE", taxAuto:false, tax:0 },
    { w:0.20, ccy:"USD", prod:"SUKUK", rate:7,  method:"SIMPLE", taxAuto:false, tax:0 },
    { w:0.10, ccy:"USD", prod:"DPM",   rate:10, method:"SIMPLE", taxAuto:false, tax:0 }
  ]);}

  function scenario3(){ applyScenario([
    { w:0.15, ccy:"TL",  prod:"TERM",  rate:35, method:"SIMPLE", taxAuto:true  },
    { w:0.45, ccy:"TL",  prod:"FUND",  rate:45, method:"SIMPLE", taxAuto:false, tax:0 },
    { w:0.20, ccy:"TL",  prod:"SUKUK", rate:38, method:"SIMPLE", taxAuto:false, tax:0 },
    { w:0.20, ccy:"USD", prod:"DPM",   rate:12, method:"SIMPLE", taxAuto:false, tax:0 }
  ]);}

  function scenario4(){ applyScenario([
    { w:0.30, ccy:"USD", prod:"SUKUK", rate:7,  method:"SIMPLE", taxAuto:false, tax:0 },
    { w:0.30, ccy:"EUR", prod:"SUKUK", rate:6,  method:"SIMPLE", taxAuto:false, tax:0 },
    { w:0.20, ccy:"TL",  prod:"SUKUK", rate:38, method:"SIMPLE", taxAuto:false, tax:0 },
    { w:0.20, ccy:"TL",  prod:"FUND",  rate:42, method:"SIMPLE", taxAuto:false, tax:0 }
  ]);}

  function scenario5(){ applyScenario([
    { w:0.50, ccy:"USD", prod:"DPM",   rate:12, method:"SIMPLE", taxAuto:false, tax:0 },
    { w:0.20, ccy:"TL",  prod:"FUND",  rate:42, method:"SIMPLE", taxAuto:false, tax:0 },
    { w:0.20, ccy:"TL",  prod:"SUKUK", rate:38, method:"SIMPLE", taxAuto:false, tax:0 },
    { w:0.10, ccy:"TL",  prod:"TERM",  rate:35, method:"SIMPLE", taxAuto:true  }
  ]);}

  // ---------- reset ----------
  function resetAll(){
    $("total_amount").value = "1,000,000";
    $("total_ccy").value = "USD";
    $("report_ccy").value = "TL";
    $("tenor_type").value = "DAYS";
    $("tenor_val").value = "183";

    $("xautry_g").value="0";
    $("usdtry").value="0";
    $("eurtry").value="0";

    $("end_mode").value="SPOT";
    $("gold_exp").value="0";

    $("xautry_g_end").value="";
    $("usdtry_end").value="";
    $("eurtry_end").value="";

    $("rtl").value="45";
    $("rusd").value="5";
    $("reur").value="3";

    $("rate_status").textContent="";
    $("warn").textContent="";
    $("pillInfo").textContent="hazır";

    $("headline_pl").textContent="-";
    $("headline_detail").textContent="";
    $("risk_badges").textContent="";

    $("kpi_used").textContent="-";
    $("kpi_left").textContent="-";
    $("kpi_total_report").textContent="-";
    $("kpi_gain_report").textContent="-";

    $("allocBody").innerHTML="";
    addRow({ amt:0, ccy:"TL", prod:"TERM", rate:35, method:"SIMPLE", taxAuto:true, roll:false, rollDays:2 });
    addRow({ amt:0, ccy:"TL", prod:"FUND", rate:42, method:"SIMPLE", taxAuto:false, tax:0 });

    $("end_note").textContent = t("endNoteSpot");
    setAmtHeader();

    // clear chart
    const c = $("chart");
    const ctx = setupHiDPI(c);
    ctx.clearRect(0,0,c.clientWidth||1200,300);
  }

  // ---------- event delegation (table) ----------
  $("allocBody").addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if(!btn) return;

    if(btn.dataset.action === "delete-row"){
      const id = btn.dataset.id;
      removeRow(id);
    }
  });

  $("allocBody").addEventListener("change", (e) => {
    const el = e.target;
    if(!el || !el.id) return;

    // prod change -> defaults + rollover ui
    if(el.id.startsWith("prod_")){
      const id = el.id.split("_")[1];
      applyDefaultsByProduct(id);
      toggleRolloverUI(id);
      refreshRowsI18n();
    }
  });

  // ---------- wire main buttons ----------
  $("btn_calc").addEventListener("click", calc);
  $("btn_reset").addEventListener("click", resetAll);
  $("btn_rates").addEventListener("click", fetchRatesAll);
  $("btn_fill_end").addEventListener("click", autoFillEndRates);

  $("btn_use_manual").addEventListener("click", () => {
    const s = getStartRates();
    const ok = (s.usdtry>0 && s.eurtry>0) || (s.xautry_g>0);
    $("rate_status").textContent = ok ? t("rateStatusManualOk") : t("rateStatusManualBad");
    autoFillEndRates();
  });

  $("btn_add").addEventListener("click", () => {
    addRow({ amt:0, ccy:"TL", prod:"TERM", rate:35, method:"SIMPLE", taxAuto:true, roll:false, rollDays:2 });
  });

  $("btn_s1").addEventListener("click", scenario1);
  $("btn_s2").addEventListener("click", scenario2);
  $("btn_s3").addEventListener("click", scenario3);
  $("btn_s4").addEventListener("click", scenario4);
  $("btn_s5").addEventListener("click", scenario5);

  $("total_ccy").addEventListener("change", setAmtHeader);

  $("end_mode").addEventListener("change", autoFillEndRates);
  $("tenor_type").addEventListener("change", autoFillEndRates);
  $("tenor_val").addEventListener("input", autoFillEndRates);
  $("rtl").addEventListener("input", autoFillEndRates);
  $("rusd").addEventListener("input", autoFillEndRates);
  $("reur").addEventListener("input", autoFillEndRates);
  $("gold_exp").addEventListener("input", autoFillEndRates);

  // language persistence
  $("lang").addEventListener("change", () => {
    localStorage.setItem("pb_lang", $("lang").value);
    applyLang();
  });

  // ---------- init ----------
  $("buildTag").textContent = "Build: " + BUILD;
  $("lang").value = getLang();
  applyLang();
  resetAll();
})();
</script>

</body>
</html>
